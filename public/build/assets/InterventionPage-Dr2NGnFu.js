import{r as o,v as B,j as e,q as M,$ as ee,m as V}from"./app-DX81JdZj.js";import{C as te}from"./ConfirmDialog--Hh1KhhH.js";import{D as ne}from"./DataTable-CXInbXMa.js";import{E as ie}from"./EmptyState-DtKuAbaw.js";import{H as oe}from"./HeaderPage-B9MDFz3D.js";import{M as G}from"./Modal-BP-UGxWA.js";import{I as g,T as H}from"./TextInput-khTo7j_K.js";import{I as h}from"./InputLabel-DLeD7tIh.js";import{g as re}from"./installationService-Bi7fEKKZ.js";import{I as se}from"./InputAutocomplete -BZW7ULco.js";import{p as ae,f as le,r as ce}from"./constant-CZa3NPxg.js";import{a as R}from"./api-2-CUCokK.js";import{S as me}from"./SelectInput-Di9ycIuw.js";import{c as de}from"./validateForm-CYV7VTEV.js";import{T as E}from"./TextArea-DX2ZV3q5.js";import{I as pe}from"./InputImage-C-n3u0I1.js";import{S as W}from"./Snackbar-B4E6_T4x.js";import{A as ue}from"./AuthenticatedLayout-BhoKsb0i.js";import{G as ve}from"./index-Bwyc8N9Y.js";import{T as _e}from"./index-BnP4Z9iX.js";import"./index-CT9OlV2B.js";import"./iconBase-NQ_muvzb.js";import"./transition-94SsWejo.js";import"./index-ChH0d0mY.js";import"./useTheme-DFAXhrBt.js";const fe=async()=>{try{return(await R.get("/maintenance")).data}catch(l){throw console.error("Erreur lors de la récupération des maintenances",l),l}},be=async l=>{try{return(await R.post("/maintenance",l)).data}catch(a){throw console.error("Erreur lors de l'enregistrement du maintenance",a),a}},he=async(l,a)=>{try{return(await R.put(`/maintenance/${l}`,a)).data}catch(r){throw console.error("Erreur lors de la modification du maintenance",r),r}},xe=async l=>{try{return(await R.delete(`/maintenance/${l}`)).data}catch(a){throw console.error("Erreur lors de la suppression du maintenance",a),a}},ge=async l=>{try{return(await R.post("/rapport-maintenances",l)).data}catch(a){throw console.error("Erreur lors de la création du rapport de maintenance",a),a}},je=({open:l=!0,setOpen:a,dataModify:r={},onCloseFormulaire:D=()=>{},idTechnicien:j})=>{const[C,i]=o.useState("Enregistrer"),[c,u]=o.useState(!1),[v,w]=o.useState({}),[m,_]=o.useState([]),[N,L]=o.useState([]),{data:f,setData:p,errors:y,reset:S}=B({installation_id:0,date_intervention:new Date().toISOString().split("T")[0],type_intervention:"préventive",description_probleme:"",solutions_apportees:"",duree_intervention:"",technicien:j}),k=async()=>{const[{data:s}]=await Promise.all([re()]),q=s.map(T=>({id:T.id,nom:T.code_installation}));_(q)},x=s=>{a(!1),I(),D(s)},I=()=>{S(),u(!1),i("Enregistrer"),w({})};o.useEffect(()=>{k(),r.id?(p({installation_id:r.installation_id||0,date_intervention:ae(r.date_intervention)||new Date().toISOString().split("T")[0],type_intervention:r.type_intervention||"",description_probleme:r.description_probleme||"",solutions_apportees:r.solutions_apportees||"",duree_intervention:r.duree_intervention||"",technicien:r.technicien_id||0}),i("Modifier")):I()},[r,p]),o.useEffect(()=>{j&&p("technicien",j)},[j,p]);const t=async()=>{if(de(f,w)){u(!0),i("Chargement...");try{let s;C==="Enregistrer"?{message:s}=await be(f):{message:s}=await he(r.id,f),x(s)}catch(s){console.error("Error submitting payment:",s)}finally{u(!1),i("Enregistrer")}}},F=s=>{p({...f,installation_id:s.id,description_probleme:s.message})};return e.jsxs(G,{show:l,closeable:!1,onClose:x,maxWidth:"lg",children:[e.jsx("div",{className:"text-2xl font-semibold text-center",children:r.nom?"Modifier une Intervention":"Ajouter une Intervention"}),e.jsxs("form",{className:"grid w-full grid-cols-1 gap-4 my-6 px-6",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"installation_id",value:"Code d'instalation"}),e.jsx(se,{data:m,className:"block w-full mt-1",onSelect:F,defaultValue:f.installation_id,readOnly:r.id,onFocus:()=>w({...v,installation_id:""})}),e.jsx(g,{message:v.installation_id||y.installation_id,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"type_intervention",value:"Type d'intervention"}),e.jsxs(me,{id:"type_intervention",type:"type_intervention",name:"type_intervention",value:f.type_intervention,className:"block w-full mt-1",autoComplete:"type_intervention",onChange:s=>p("type_intervention",s.target.value),required:!0,children:[e.jsx("option",{value:"préventive",children:"Préventive"}),e.jsx("option",{value:"curative",children:"Curative"})]}),e.jsx(g,{message:y.email,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"description_probleme",value:"Description du problème"}),e.jsx(E,{id:"description_probleme",name:"description_probleme",value:f.description_probleme,className:"block w-full mt-1",autoComplete:"description_probleme",onChange:s=>p("description_probleme",s.target.value),required:!0,rows:4,onFocus:()=>w({...v,description_probleme:""})}),e.jsx(g,{message:v.description_probleme||y.description_probleme,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"date_intervention",value:"Date d'intervention"}),e.jsx(H,{id:"date_intervention",name:"date_intervention",value:f.date_intervention,className:"block w-full mt-1",autoComplete:"date_intervention",type:"date",onChange:s=>p("date_intervention",s.target.value),required:!0,onFocus:()=>w({...v,date_intervention:""})}),e.jsx(g,{message:v.date_intervention||y.date_intervention,className:"mt-2"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-4 px-6",children:[e.jsx("button",{type:"button",className:"px-4 py-1 text-red-500 rounded-md bg-red-400/10",onClick:()=>x(""),children:"Fermer"}),e.jsx("button",{type:"submit",className:`rounded-md py-1 px-4 disabled:cursor-not-allowed bg-blue-500 text-white ${c&&"opacity-25"}`,disabled:c,onClick:t,children:C})]})]})},we=({open:l=!0,setOpen:a,dataModify:r={},onCloseFormulaire:D=()=>{},idTechnicien:j})=>{const C=new Date().toISOString().split("T")[0],{data:i,setData:c,errors:u}=B({clientId:0,technicienId:j,maintenanceId:0,description_probleme:"",photo_probleme:null,verifications_preliminaires:"",resultat_diagnostic:"",actions_correctives:"",verification_fonctionnement:"",recommandations:"",date_intervention:C}),[v,w]=o.useState(!1),[m,_]=o.useState({}),[N,L]=o.useState({show:!1,message:"",type:"info"});o.useEffect(()=>{r&&(c("maintenanceId",r.id),c("clientId",r.idclient),c("description_probleme",r.description_probleme))},[r]);const f=o.useRef(null),[p,y]=o.useState({}),S=t=>{a(!1),c({clientId:0,technicienId:j||1,maintenanceId:0,description_probleme:"",photo_probleme:null,verifications_preliminaires:"",resultat_diagnostic:"",actions_correctives:"",verification_fonctionnement:"",recommandations:"",date_intervention:C}),D(t)},k=t=>{c("photo_probleme",t),p.photo_probleme&&y({...p,photo_probleme:""})},x=()=>{const t={};return i.description_probleme.trim()||(t.description_probleme="Le problème rapporté est obligatoire"),i.verifications_preliminaires.trim()||(t.verifications_preliminaires="Les vérifications préliminaires sont obligatoires"),i.resultat_diagnostic.trim()||(t.resultat_diagnostic="Le résultat du diagnostic est obligatoire"),i.actions_correctives.trim()||(t.actions_correctives="Les actions correctives sont obligatoires"),i.verification_fonctionnement.trim()||(t.verification_fonctionnement="La vérification du fonctionnement est obligatoire"),i.date_intervention||(t.date_intervention="La date d'intervention est obligatoire"),_(t),Object.keys(t).length===0},I=async()=>{if(x()){i.technicienId=j;try{w(!0);const t=new FormData;t.append("clientId",i.clientId),t.append("technicienId",i.technicienId),t.append("maintenanceId",i.maintenanceId),t.append("description_probleme",i.description_probleme),i.photo_probleme&&t.append("photo_probleme",i.photo_probleme),t.append("verifications_preliminaires",i.verifications_preliminaires),t.append("resultat_diagnostic",i.resultat_diagnostic),t.append("actions_correctives",i.actions_correctives),t.append("verification_fonctionnement",i.verification_fonctionnement),t.append("recommandations",i.recommandations),t.append("date_intervention",i.date_intervention);const F=await ge(t);S(F.message)}catch(t){console.error("Erreur lors de la création du rapport:",t),L({show:!0,message:"Une erreur est survenue lors de la création du rapport",type:"error"})}finally{w(!1)}}};return e.jsxs(G,{show:l,closeable:!1,onClose:S,maxWidth:"xl",children:[e.jsx("div",{className:"text-2xl font-semibold text-center",children:"Formulaire rapport maintenance"}),e.jsxs("form",{className:"grid w-full grid-cols-1 gap-4 my-6 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"description_probleme",value:"Problème rapporté *"}),e.jsx(E,{id:"description_probleme",name:"description_probleme",value:i.description_probleme,className:"block w-full mt-1",autoComplete:"off",onChange:t=>c("description_probleme",t.target.value),required:!0,rows:3,readOnly:!0,onFocus:()=>_({...m,description_probleme:""})}),e.jsx(g,{message:m.description_probleme||p.description_probleme||u.description_probleme,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"verifications_preliminaires",value:"Vérifications préliminaires *"}),e.jsx(E,{id:"verifications_preliminaires",name:"verifications_preliminaires",value:i.verifications_preliminaires,className:"block w-full mt-1",autoComplete:"off",onChange:t=>c("verifications_preliminaires",t.target.value),required:!0,rows:3,onFocus:()=>_({...m,verifications_preliminaires:""})}),e.jsx(g,{message:m.verifications_preliminaires||u.verifications_preliminaires,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"resultat_diagnostic",value:"Résultat du diagnostic *"}),e.jsx(E,{id:"resultat_diagnostic",name:"resultat_diagnostic",value:i.resultat_diagnostic,className:"block w-full mt-1",autoComplete:"off",onChange:t=>c("resultat_diagnostic",t.target.value),required:!0,rows:3,onFocus:()=>_({...m,resultat_diagnostic:""})}),e.jsx(g,{message:m.resultat_diagnostic||u.resultat_diagnostic,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"actions_correctives",value:"Actions correctives *"}),e.jsx(E,{id:"actions_correctives",name:"actions_correctives",value:i.actions_correctives,className:"block w-full mt-1",autoComplete:"off",onChange:t=>c("actions_correctives",t.target.value),required:!0,rows:3,onFocus:()=>_({...m,actions_correctives:""})}),e.jsx(g,{message:m.actions_correctives||u.actions_correctives,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"verification_fonctionnement",value:"Vérification du fonctionnement *"}),e.jsx(E,{id:"verification_fonctionnement",name:"verification_fonctionnement",value:i.verification_fonctionnement,className:"block w-full mt-1",autoComplete:"off",onChange:t=>c("verification_fonctionnement",t.target.value),required:!0,rows:3,onFocus:()=>_({...m,verification_fonctionnement:""})}),e.jsx(g,{message:m.verification_fonctionnement||u.verification_fonctionnement,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"recommandations",value:"Recommandations au Client (optionnel)"}),e.jsx(E,{id:"recommandations",name:"recommandations",value:i.recommandations,className:"block w-full mt-1",autoComplete:"off",onChange:t=>c("recommandations",t.target.value),rows:3,onFocus:()=>_({...m,recommandations:""})}),e.jsx(g,{message:u.recommandations,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"photo_probleme",value:"Photo du problème (optionnel)"}),e.jsx(pe,{ref:f,selectedFile:i.photo_probleme,onLoadFile:k,onFocus:()=>y({...p,photo_probleme:""})})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"date_intervention",value:"Date de l'intervention *"}),e.jsx(H,{id:"date_intervention",name:"date_intervention",value:i.date_intervention,className:"block w-full mt-1",autoComplete:"off",onChange:t=>c("date_intervention",t.target.value),type:"date",required:!0,readOnly:!0,onFocus:()=>_({...m,date_intervention:""})}),e.jsx(g,{message:m.date_intervention||u.date_intervention,className:"mt-2"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-4 px-1",children:[e.jsx("button",{type:"button",className:"px-4 py-1 text-red-500 rounded-md bg-red-400/10",onClick:()=>S(""),children:"Fermer"}),e.jsx("button",{type:"submit",className:`rounded-md py-1 px-4 disabled:cursor-not-allowed bg-blue-500 text-white ${v&&"opacity-25"}`,disabled:v,onClick:I,children:v?"Enregistrement...":"Enregistrer"})]}),e.jsx(W,{show:N.show,message:N.message,type:N.type,onClose:()=>L({...N,show:!1})})]})},Ke=()=>{const[l,a]=o.useState(""),[r,D]=o.useState(0),[j,C]=o.useState(!1),[i,c]=o.useState(!1),[u,v]=o.useState({}),[w,m]=o.useState({}),[_,N]=o.useState(1),[L,f]=o.useState([]),[p,y]=o.useState([]),[S,k]=o.useState(!0),[x,I]=o.useState({open:!1,message:"",id:0}),[t,F]=o.useState({open:!1,message:"",type:"success"}),s=M().props.auth.user,q=[{key:"id",label:"ID"},{key:"code_installation",label:"Installation"},{key:"nom",label:"Client"},{key:"type_intervention",label:"Type"},{key:"description_probleme",label:"Problème",customRender:n=>e.jsxs("div",{className:"relative max-w-md group",children:[e.jsx("span",{className:"line-clamp-2",children:n}),e.jsx("div",{className:"absolute bottom-0 left-0 z-50 hidden max-w-md p-2 mt-2 text-sm text-gray-800 bg-white border border-gray-300 rounded shadow-md group-hover:block",children:n})]})},{key:"date_intervention",label:"Date d'intervenir"},{key:"status_intervention",label:"Statuts",customRender:n=>e.jsx("span",{className:`px-2 py-1 rounded-full text-white flex text-nowrap ${n==="terminée"?"bg-green-500/50":n==="en attente"?"bg-blue-500/50":"bg-red-500/50"}`,children:n})},{key:"status_intervention",label:"Rapport",customRender:(n,b)=>{var d,$,A;return e.jsx("span",{onClick:()=>{var O;return n==="terminée"?V.visit("/rapport",{data:{intervention_id:b.id}}):((O=s.user_role)==null?void 0:O.name)==="partenaire"?null:U(b)},className:`px-2 py-1 rounded-full flex text-nowrap ${((d=s.user_role)==null?void 0:d.name)==="partenaire"&&n!=="terminée"?"cursor-default":"cursor-pointer"} ${n==="terminée"?"text-green-500":(($=s.user_role)==null?void 0:$.name)==="partenaire"?"text-gray-300":"text-blue-500"}`,children:n==="terminée"?"Consulter":((A=s.user_role)==null?void 0:A.name)==="partenaire"?"En attente":"Ajouter"})}}],T=[{label:e.jsx(_e,{className:"text-lg"}),color:"text-blue-500",hoverColor:"text-blue-600",handler:n=>Z(n)},{label:e.jsx(ve,{className:"text-base"}),color:"text-red-500",hoverColor:"text-red-600",handler:n=>X(n)}],z=()=>{C(!0)},U=n=>{var b;((b=s.user_role)==null?void 0:b.name)==="partenaire"?V.visit("/rapport",{data:{intervention_id:n.id}}):(c(!0),m(n))},P=async()=>{k(!0);const{data:n}=await fe(),b=n.map(d=>({id:d.id,installation_id:d.installation_id,code_installation:d.installation.code_installation,nom:d.installation.client.nom+" "+d.installation.client.prenom,idclient:d.installation.client.id,type_intervention:d.type_intervention,description_probleme:d.description_probleme,status_intervention:d.status_intervention,date_intervention:le(d.date_intervention)}));f(b),y(b),k(!1)};o.useEffect(()=>{P()},[]);const J=n=>{a(n),N(1);const b=L.filter(d=>d.nom.toLowerCase().includes(n.toLowerCase())||d.type_intervention.toLowerCase().includes(n.toLowerCase())||d.description_probleme.toLowerCase().includes(n.toLowerCase())||d.date_intervention.toString().toLowerCase().includes(n.toLowerCase()));y(b)},K=n=>{P(),n&&F({...t,message:n,open:!0}),v({})},Q=n=>{P(),n&&F({...t,message:n,open:!0}),m({})},X=n=>{I({open:!0,message:`Êtes-vous sûr de vouloir supprimer l'intervention du ${n.nom} le ${n.date_intervention} ?`,id:n.id})},Y=async()=>{const{message:n}=await xe(x.id);F({...t,message:n,open:!0}),I({...x,open:!1,id:0}),P(),N(1)},Z=n=>{const b=n.date_intervention?n.date_intervention:"Invalid date";v({...n,date_intervention:ce(b)}),C(!0)};return e.jsxs(ue,{setId:D,children:[e.jsx(ee,{title:"Maintenance"}),e.jsx(oe,{search:l,onSearch:J,title:"Liste des interventions",handleClick:z}),e.jsx(W,{message:t.message,type:t.type,duration:3e3,position:"top-right",show:t.open,onClose:()=>F({...t,message:"",open:!1})}),e.jsx(te,{open:x.open,message:x.message,btnAcceptName:"Supprimer",title:"Suppression",btnAcceptColor:"bg-red-500 text-white",close:()=>I({...x,open:!1}),accept:Y}),e.jsx(je,{open:j,setOpen:C,dataModify:u,onCloseFormulaire:K,idTechnicien:r}),e.jsx(we,{open:i,setOpen:c,dataModify:w,onCloseFormulaire:Q,idTechnicien:r}),S?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"w-12 h-12 border-t-2 border-b-2 border-blue-500 rounded-full animate-spin"})}):e.jsx("div",{children:p.length>0?e.jsx(ne,{headers:q,rows:p,itemsPerPage:6,actions:T,className:"mt-4",currentPage:_,onPageChange:N,masqueColumns:["client_id"]}):e.jsx(ie,{nom:"intervention",search:l})})]})};export{Ke as default};
