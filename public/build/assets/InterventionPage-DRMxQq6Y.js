import{r as s,m as q,j as e,L as K,S as Q}from"./app-lEwSGBr3.js";import{C as X,D as Y,G as Z}from"./index-C9dT6W-9.js";import{H as M}from"./HeaderPage-DuJHnBqU.js";import{M as A}from"./Modal-DnPeP_aG.js";import{I as g,T as P}from"./TextInput-DzHQcyWx.js";import{I as _}from"./InputLabel-pWKg6feR.js";import{g as ee}from"./installationService-DAMoKzAJ.js";import{I as te}from"./InputAutocomplete -C7Zsd-xm.js";import{o as ne,n as oe,f as ie,q as re}from"./constant-BYDvtrQa.js";import{a as R}from"./api-BmiIDVS8.js";import{S as se}from"./SelectInput-DCe3oIlx.js";import{c as ae}from"./validateForm-C-Be7ugn.js";import{I as le}from"./InputImage-dBS97iJY.js";import{S as O}from"./Snackbar-D-29GX2q.js";import{A as ce}from"./AuthenticatedLayout-o_ISxKCL.js";import{T as de}from"./index-DjmV4M__.js";import"./iconBase-CWbNXOs-.js";import"./index-Bxz5jMhy.js";import"./transition-jhi5EtKO.js";import"./useTheme-BkEXnhhe.js";const me=async()=>{try{return(await R.get("/maintenance")).data}catch(c){throw console.error("Erreur lors de la récupération des maintenances",c),c}},pe=async c=>{try{return(await R.post("/maintenance",c)).data}catch(a){throw console.error("Erreur lors de l'enregistrement du maintenance",a),a}},ue=async(c,a)=>{try{return(await R.put(`/maintenance/${c}`,a)).data}catch(r){throw console.error("Erreur lors de la modification du maintenance",r),r}},ve=async c=>{try{return(await R.delete(`/maintenance/${c}`)).data}catch(a){throw console.error("Erreur lors de la suppression du maintenance",a),a}},_e=async c=>{try{return(await R.post("/rapport-maintenances",c)).data}catch(a){throw console.error("Erreur lors de la création du rapport de maintenance",a),a}},fe=({open:c=!0,setOpen:a,dataModify:r={},onCloseFormulaire:S=()=>{},idTechnicien:x})=>{const[h,o]=s.useState("Enregistrer"),[d,v]=s.useState(!1),[b,f]=s.useState({}),[I,m]=s.useState([]);s.useState([]);const{data:l,setData:p,errors:j,reset:D}=q({installation_id:0,date_intervention:new Date().toISOString().split("T")[0],type_intervention:"préventive",description_probleme:"",solutions_apportees:"",duree_intervention:"",technicien:x}),y=async()=>{const[{data:i}]=await Promise.all([ee()]),t=i.map(L=>({id:L.id,nom:L.code_installation}));m(t)},F=i=>{a(!1),w(),S(i)},w=()=>{D(),v(!1),o("Enregistrer"),f({})};s.useEffect(()=>{y(),r.id?(p({installation_id:r.installation_id||0,date_intervention:ne(r.date_intervention)||new Date().toISOString().split("T")[0],type_intervention:r.type_intervention||"",description_probleme:r.description_probleme||"",solutions_apportees:r.solutions_apportees||"",duree_intervention:r.duree_intervention||"",technicien:r.technicien_id||0}),o("Modifier")):w()},[r,p]),s.useEffect(()=>{x&&p("technicien",x)},[x,p]);const C=async()=>{if(ae(l,f)){v(!0),o("Chargement...");try{let i;h==="Enregistrer"?{message:i}=await pe(l):{message:i}=await ue(r.id,l),F(i)}catch(i){console.error("Error submitting payment:",i)}finally{v(!1),o("Enregistrer")}}},k=i=>{p({...l,installation_id:i.id,description_probleme:i.message})};return e.jsxs(A,{show:c,closeable:!1,onClose:F,maxWidth:"xl",children:[e.jsx("div",{className:"text-2xl font-semibold text-center",children:r.nom?"Modifier une Intervention":"Ajouter une Intervention"}),e.jsxs("form",{className:"grid w-full grid-cols-1 gap-4 my-6 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(_,{htmlFor:"installation_id",value:"Code d'instalation"}),e.jsx(te,{data:I,className:"block w-full mt-1",onSelect:k,isFocused:!0,defaultValue:l.installation_id,readOnly:r.id,onFocus:()=>f({...b,installation_id:""})}),e.jsx(g,{message:b.installation_id||j.installation_id,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"type_intervention",value:"Type d'intervention"}),e.jsxs(se,{id:"type_intervention",type:"type_intervention",name:"type_intervention",value:l.type_intervention,className:"block w-full mt-1",autoComplete:"type_intervention",onChange:i=>p("type_intervention",i.target.value),required:!0,children:[e.jsx("option",{value:"préventive",children:"Préventive"}),e.jsx("option",{value:"curative",children:"Curative"})]}),e.jsx(g,{message:j.email,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"description_probleme",value:"Description du problème"}),e.jsx(P,{id:"description_probleme",name:"description_probleme",value:l.description_probleme,className:"block w-full mt-1",autoComplete:"description_probleme",onChange:i=>p("description_probleme",i.target.value),required:!0,onFocus:()=>f({...b,description_probleme:""})}),e.jsx(g,{message:b.description_probleme||j.description_probleme,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"date_intervention",value:"Date d'intervention"}),e.jsx(P,{id:"date_intervention",name:"date_intervention",value:l.date_intervention,className:"block w-full mt-1",autoComplete:"date_intervention",type:"date",onChange:i=>p("date_intervention",i.target.value),required:!0,onFocus:()=>f({...b,date_intervention:""})}),e.jsx(g,{message:b.date_intervention||j.date_intervention,className:"mt-2"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-4 px-1",children:[e.jsx("button",{type:"button",className:"px-4 py-1 text-red-500 rounded-md bg-red-400/10",onClick:()=>F(""),children:"Fermer"}),e.jsx("button",{type:"submit",className:`rounded-md py-1 px-4 disabled:cursor-not-allowed bg-blue-500 text-white ${d&&"opacity-25"}`,disabled:d,onClick:C,children:h})]})]})},E=s.forwardRef(({className:c="",readOnly:a=!1,...r},S)=>e.jsx("textarea",{...r,readOnly:a,className:"rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 dark:focus:border-indigo-600 dark:focus:ring-indigo-600 "+(a?"bg-gray-100 cursor-not-allowed ":"")+c,ref:S}));E.displayName="TextArea";const ge=({open:c=!0,setOpen:a,dataModify:r={},onCloseFormulaire:S=()=>{},idTechnicien:x})=>{const h=new Date().toISOString().split("T")[0],{data:o,setData:d,errors:v,reset:b}=q({clientId:0,technicienId:x||1,maintenanceId:0,description_probleme:"",photo_probleme:null,verifications_preliminaires:"",resultat_diagnostic:"",actions_correctives:"",verification_fonctionnement:"",recommandations:"",date_intervention:h}),[f,I]=s.useState(!1),[m,l]=s.useState({}),[p,j]=s.useState({show:!1,message:"",type:"info"});s.useEffect(()=>{r&&(d("maintenanceId",r.id),d("clientId",r.idclient),d("description_probleme",r.description_probleme))},[r]);const D=s.useRef(null),[y,F]=s.useState({}),w=t=>{a(!1),d({clientId:0,technicienId:x||1,maintenanceId:0,description_probleme:"",photo_probleme:null,verifications_preliminaires:"",resultat_diagnostic:"",actions_correctives:"",verification_fonctionnement:"",recommandations:"",date_intervention:h}),S(t)},C=t=>{d("photo_probleme",t),y.photo_probleme&&F({...y,photo_probleme:""})},k=()=>{const t={};return o.description_probleme.trim()||(t.description_probleme="Le problème rapporté est obligatoire"),o.verifications_preliminaires.trim()||(t.verifications_preliminaires="Les vérifications préliminaires sont obligatoires"),o.resultat_diagnostic.trim()||(t.resultat_diagnostic="Le résultat du diagnostic est obligatoire"),o.actions_correctives.trim()||(t.actions_correctives="Les actions correctives sont obligatoires"),o.verification_fonctionnement.trim()||(t.verification_fonctionnement="La vérification du fonctionnement est obligatoire"),o.date_intervention||(t.date_intervention="La date d'intervention est obligatoire"),l(t),Object.keys(t).length===0},i=async()=>{if(k())try{I(!0);const t=new FormData;t.append("clientId",o.clientId),t.append("technicienId",o.technicienId),t.append("maintenanceId",o.maintenanceId),t.append("description_probleme",o.description_probleme),o.photo_probleme&&t.append("photo_probleme",o.photo_probleme),t.append("verifications_preliminaires",o.verifications_preliminaires),t.append("resultat_diagnostic",o.resultat_diagnostic),t.append("actions_correctives",o.actions_correctives),t.append("verification_fonctionnement",o.verification_fonctionnement),t.append("recommandations",o.recommandations),t.append("date_intervention",o.date_intervention);const L=await _e(t);w(L.message)}catch(t){console.error("Erreur lors de la création du rapport:",t),j({show:!0,message:"Une erreur est survenue lors de la création du rapport",type:"error"})}finally{I(!1)}};return e.jsxs(A,{show:c,closeable:!1,onClose:w,maxWidth:"xl",children:[e.jsx("div",{className:"text-2xl font-semibold text-center",children:"Formulaire rapport maintenance"}),e.jsxs("form",{className:"grid w-full grid-cols-1 gap-4 my-6 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(_,{htmlFor:"description_probleme",value:"Problème rapporté *"}),e.jsx(E,{id:"description_probleme",name:"description_probleme",value:o.description_probleme,className:"block w-full mt-1",autoComplete:"off",onChange:t=>d("description_probleme",t.target.value),required:!0,rows:3,readOnly:!0,onFocus:()=>l({...m,description_probleme:""})}),e.jsx(g,{message:m.description_probleme||y.description_probleme||v.description_probleme,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"verifications_preliminaires",value:"Vérifications préliminaires *"}),e.jsx(E,{id:"verifications_preliminaires",name:"verifications_preliminaires",value:o.verifications_preliminaires,className:"block w-full mt-1",autoComplete:"off",onChange:t=>d("verifications_preliminaires",t.target.value),required:!0,rows:3,onFocus:()=>l({...m,verifications_preliminaires:""})}),e.jsx(g,{message:m.verifications_preliminaires||v.verifications_preliminaires,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"resultat_diagnostic",value:"Résultat du diagnostic *"}),e.jsx(E,{id:"resultat_diagnostic",name:"resultat_diagnostic",value:o.resultat_diagnostic,className:"block w-full mt-1",autoComplete:"off",onChange:t=>d("resultat_diagnostic",t.target.value),required:!0,rows:3,onFocus:()=>l({...m,resultat_diagnostic:""})}),e.jsx(g,{message:m.resultat_diagnostic||v.resultat_diagnostic,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"actions_correctives",value:"Actions correctives *"}),e.jsx(E,{id:"actions_correctives",name:"actions_correctives",value:o.actions_correctives,className:"block w-full mt-1",autoComplete:"off",onChange:t=>d("actions_correctives",t.target.value),required:!0,rows:3,onFocus:()=>l({...m,actions_correctives:""})}),e.jsx(g,{message:m.actions_correctives||v.actions_correctives,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"verification_fonctionnement",value:"Vérification du fonctionnement *"}),e.jsx(E,{id:"verification_fonctionnement",name:"verification_fonctionnement",value:o.verification_fonctionnement,className:"block w-full mt-1",autoComplete:"off",onChange:t=>d("verification_fonctionnement",t.target.value),required:!0,rows:3,onFocus:()=>l({...m,verification_fonctionnement:""})}),e.jsx(g,{message:m.verification_fonctionnement||v.verification_fonctionnement,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"recommandations",value:"Recommandations au Client (optionnel)"}),e.jsx(E,{id:"recommandations",name:"recommandations",value:o.recommandations,className:"block w-full mt-1",autoComplete:"off",onChange:t=>d("recommandations",t.target.value),rows:3,onFocus:()=>l({...m,recommandations:""})}),e.jsx(g,{message:v.recommandations,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"photo_probleme",value:"Photo du problème (optionnel)"}),e.jsx(le,{ref:D,selectedFile:o.photo_probleme,onLoadFile:C,onFocus:()=>F({...y,photo_probleme:""})})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"date_intervention",value:"Date de l'intervention *"}),e.jsx(P,{id:"date_intervention",name:"date_intervention",value:o.date_intervention,className:"block w-full mt-1",autoComplete:"off",onChange:t=>d("date_intervention",t.target.value),type:"date",required:!0,readOnly:!0,onFocus:()=>l({...m,date_intervention:""})}),e.jsx(g,{message:m.date_intervention||v.date_intervention,className:"mt-2"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-4 px-1",children:[e.jsx("button",{type:"button",className:"px-4 py-1 text-red-500 rounded-md bg-red-400/10",onClick:()=>w(""),children:"Fermer"}),e.jsx("button",{type:"submit",className:`rounded-md py-1 px-4 disabled:cursor-not-allowed bg-blue-500 text-white ${f&&"opacity-25"}`,disabled:f,onClick:i,children:f?"Enregistrement...":"Enregistrer"})]}),e.jsx(O,{show:p.show,message:p.message,type:p.type,onClose:()=>j({...p,show:!1})})]})},Oe=()=>{const[c,a]=s.useState(""),[r,S]=s.useState(0),[x,h]=s.useState(!1),[o,d]=s.useState(!1),[v,b]=s.useState({}),[f,I]=s.useState({}),[m,l]=s.useState(1),[p,j]=s.useState([]),[D,y]=s.useState([]),[F,w]=s.useState(!0),[C,k]=s.useState({open:!1,message:"",id:0}),[i,t]=s.useState({open:!1,message:"",type:"success"}),L=[{key:"id",label:"ID"},{key:"code_installation",label:"Installation"},{key:"nom",label:"Client"},{key:"type_intervention",label:"Type"},{key:"description_probleme",label:"Problème"},{key:"date_intervention",label:"Date d'intervenir"},{key:"status_intervention",label:"Statuts",customRender:n=>e.jsx("span",{className:`px-2 py-1 rounded-full text-white flex text-nowrap ${n==="terminée"?"bg-green-500/50":n==="en attente"?"bg-blue-500/50":"bg-red-500/50"}`,children:n})},{key:"status_intervention",label:"Rapport",customRender:(n,N)=>e.jsx("span",{onClick:()=>n==="terminée"?Q.visit("/rapport",{data:{intervention_id:N.id}}):B(N),className:`px-2 py-1 rounded-full flex text-nowrap cursor-pointer ${n==="terminée"?"text-green-500":"text-blue-500"}`,children:n==="terminée"?"Consulter":"Ajouter"})}],$=[{label:e.jsx(de,{className:"text-lg"}),color:"text-blue-500",hoverColor:"text-blue-600",handler:n=>J(n)},{label:e.jsx(Z,{className:"text-base"}),color:"text-red-500",hoverColor:"text-red-600",handler:n=>U(n)}],V=()=>{h(!0)},B=n=>{d(!0),I(n)},T=async()=>{w(!0);const{data:n}=await me(),N=n.map(u=>({id:u.id,installation_id:u.installation_id,code_installation:u.installation.code_installation,nom:u.installation.client.nom+" "+u.installation.client.prenom,idclient:u.installation.client.id,type_intervention:u.type_intervention,description_probleme:u.description_probleme,status_intervention:u.status_intervention,date_intervention:ie(u.date_intervention)}));j(N),y(N),w(!1)};s.useEffect(()=>{T()},[]);const G=n=>{a(n),l(1);const N=p.filter(u=>u.nom.toLowerCase().includes(n.toLowerCase())||u.type_intervention.toLowerCase().includes(n.toLowerCase())||u.description_probleme.toLowerCase().includes(n.toLowerCase())||u.date_intervention.toString().toLowerCase().includes(n.toLowerCase()));y(N)},H=n=>{T(),n&&t({...i,message:n,open:!0}),b({})},W=n=>{T(),n&&t({...i,message:n,open:!0}),I({})},U=n=>{k({open:!0,message:`Êtes-vous sûr de vouloir supprimer l'intervention du ${n.nom} le ${n.date_intervention} ?`,id:n.id})},z=async()=>{const{message:n}=await ve(C.id);t({...i,message:n,open:!0}),k({...C,open:!1,id:0}),T(),l(1)},J=n=>{const N=n.date_intervention?n.date_intervention:"Invalid date";b({...n,date_intervention:re(N)}),h(!0)};return e.jsxs(ce,{setId:S,children:[e.jsx(K,{title:"Maintenance"}),e.jsx(M,{search:c,onSearch:G,title:"Liste des interventions",handleClick:V}),e.jsx(O,{message:i.message,type:i.type,duration:3e3,position:"top-right",show:i.open,onClose:()=>t({...i,message:"",open:!1})}),e.jsx(X,{open:C.open,message:C.message,btnAcceptName:"Supprimer",title:"Suppression",btnAcceptColor:"bg-red-500 text-white",close:()=>k({...C,open:!1}),accept:z}),e.jsx(fe,{open:x,setOpen:h,dataModify:v,onCloseFormulaire:H,idTechnicien:r}),e.jsx(ge,{open:o,setOpen:d,dataModify:f,onCloseFormulaire:W,idTechnicien:r}),F?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):e.jsx("div",{children:D.length>0?e.jsx(Y,{headers:L,rows:D,itemsPerPage:6,actions:$,className:"mt-4",currentPage:m,onPageChange:l,masqueColumns:["client_id"]}):e.jsx("div",{className:"flex justify-center",children:e.jsx("img",{src:oe,alt:"no data",className:"max-w-md mt-2 opacity-50"})})})]})};export{Oe as default};
