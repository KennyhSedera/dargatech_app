import{r,v as V,j as e,q as te,$ as ne,m as O}from"./app-CNOETwtv.js";import{C as oe}from"./ConfirmDialog-C871Sm_y.js";import{D as ie}from"./DataTable-B_LjaVOM.js";import{E as re}from"./EmptyState-BSPfpYAy.js";import{H as se}from"./HeaderPage-DWXnepMR.js";import{M as B}from"./Modal-3Caw8zDr.js";import{I as h,T as z}from"./TextInput-E0IY2eMq.js";import{I as _}from"./InputLabel-CkJz6wxT.js";import{g as ae}from"./installationService-BGW7lpD3.js";import{I as le}from"./InputAutocomplete -DMIFP5QG.js";import{r as ce,f as me,q as pe}from"./constant-CGdnuimt.js";import{c as de,u as ue,a as _e,g as ve,d as fe}from"./maintenanceService-Bp_7HqW1.js";import{S as be}from"./SelectInput-DedJc32V.js";import{a as he}from"./validateForm-f9K0gDaZ.js";import"./api-b0jzamnG.js";import{T as k}from"./TextArea-DLCrAmls.js";import{I as G}from"./InputImage-eykEhDpx.js";import{S as H}from"./Snackbar-lAYbKtpT.js";import{A as xe}from"./AuthenticatedLayout-bDb7gLtw.js";import{G as ge}from"./index-CSN6Yh_8.js";import{T as je}from"./index-qZRnsh8a.js";import"./index-Bf-czcdr.js";import"./iconBase-BDSg09zG.js";import"./transition-Aii3EWeo.js";import"./createLucideIcon-B1pyjjUi.js";import"./useTheme-CL5jlrCN.js";const ye=({open:D=!0,setOpen:L,dataModify:s={},onCloseFormulaire:R=()=>{},idTechnicien:x})=>{const[j,o]=r.useState("Enregistrer"),[a,u]=r.useState(!1),[p,v]=r.useState({}),[l,f]=r.useState([]),{data:c,setData:d,errors:y,reset:w}=V({installation_id:0,date_intervention:new Date().toISOString().split("T")[0],type_intervention:"préventive",description_probleme:"",solutions_apportees:"",duree_intervention:"",technicien:x,photo_probleme:[]}),F=r.useRef(null),I=async()=>{const[{data:i}]=await Promise.all([ae()]),P=i.filter(E=>E.statuts!=="en panne").map(E=>({id:E.id,nom:E.code_installation}));f(P)},N=i=>{L(!1),g(),R(i)},g=()=>{w(),u(!1),o("Enregistrer"),v({})};r.useEffect(()=>{I(),s.id?(d({installation_id:s.installation_id||0,date_intervention:ce(s.date_intervention)||new Date().toISOString().split("T")[0],type_intervention:s.type_intervention||"",description_probleme:s.description_probleme||"",solutions_apportees:s.solutions_apportees||"",duree_intervention:s.duree_intervention||"",technicien:s.technicien_id||0}),o("Modifier")):g()},[s,d]),r.useEffect(()=>{x&&d("technicien",x)},[x,d]);const S=async()=>{if(he(c,v)){u(!0),o("Chargement...");try{let i;j==="Enregistrer"?{message:i}=await de(c):{message:i}=await ue(s.id,c),N(i)}catch(i){console.error("Error submitting payment:",i)}finally{u(!1),o("Enregistrer")}}},t=i=>{d({...c,installation_id:i.id,description_probleme:i.message})},C=i=>{d("photo_probleme",i),p.photo_probleme&&v({...p,photo_probleme:""})};return e.jsxs(B,{show:D,closeable:!1,onClose:N,maxWidth:"4xl",children:[e.jsx("div",{className:"text-2xl font-semibold text-center",children:s.nom?"Modifier une Intervention":"Ajouter une Intervention"}),e.jsxs("form",{className:"grid w-full grid-cols-2 gap-4 px-6 my-6",children:[e.jsxs("div",{children:[e.jsx(_,{htmlFor:"installation_id",value:"Code d'instalation"}),e.jsx(le,{data:l,className:"block w-full mt-1",onSelect:t,defaultValue:c.installation_id,readOnly:s.id,onFocus:()=>v({...p,installation_id:""})}),e.jsx(h,{message:p.installation_id||y.installation_id,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"type_intervention",value:"Type d'intervention"}),e.jsxs(be,{id:"type_intervention",type:"type_intervention",name:"type_intervention",value:c.type_intervention,className:"block w-full mt-1",autoComplete:"type_intervention",onChange:i=>d("type_intervention",i.target.value),required:!0,children:[e.jsx("option",{value:"préventive",children:"Préventive"}),e.jsx("option",{value:"curative",children:"Curative"})]}),e.jsx(h,{message:y.email,className:"mt-2"})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx(_,{htmlFor:"description_probleme",value:"Description du problème"}),e.jsx(k,{id:"description_probleme",name:"description_probleme",value:c.description_probleme,className:"block w-full mt-1",autoComplete:"description_probleme",onChange:i=>d("description_probleme",i.target.value),required:!0,rows:4,onFocus:()=>v({...p,description_probleme:""})}),e.jsx(h,{message:p.description_probleme||y.description_probleme,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"solutions_apportees",value:"Photo du problème"}),e.jsx(G,{ref:F,selectedFiles:c.photo_probleme,onLoadFile:C,onFocus:()=>v({...p,photo_probleme:""}),multiple:!0,placeholder:"Sélectionner des photos"}),e.jsx(h,{message:p.photo_probleme||y.photo_probleme,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"date_intervention",value:"Date d'intervention"}),e.jsx(z,{id:"date_intervention",name:"date_intervention",value:c.date_intervention,className:"block w-full mt-1",autoComplete:"date_intervention",type:"date",onChange:i=>d("date_intervention",i.target.value),required:!0,onFocus:()=>v({...p,date_intervention:""})}),e.jsx(h,{message:p.date_intervention||y.date_intervention,className:"mt-2"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-4 px-6",children:[e.jsx("button",{type:"button",className:"px-4 py-1 text-red-500 rounded-md bg-red-400/10",onClick:()=>N(""),children:"Fermer"}),e.jsx("button",{type:"submit",className:`rounded-md py-1 px-4 disabled:cursor-not-allowed bg-blue-500 text-white ${a&&"opacity-25"}`,disabled:a,onClick:S,children:j})]})]})},we=({open:D=!0,setOpen:L,dataModify:s={},onCloseFormulaire:R=()=>{},idTechnicien:x})=>{const j=new Date().toISOString().split("T")[0],{data:o,setData:a,errors:u}=V({clientId:0,technicienId:x,maintenanceId:0,description_probleme:"",photo_probleme:[],verifications_preliminaires:"",resultat_diagnostic:"",actions_correctives:"",verification_fonctionnement:"",recommandations:"",date_intervention:j}),[p,v]=r.useState(!1),[l,f]=r.useState({}),[c,d]=r.useState({show:!1,message:"",type:"info"});r.useEffect(()=>{s&&(a("maintenanceId",s.id),a("clientId",s.idclient),a("description_probleme",s.description_probleme))},[s]);const y=r.useRef(null),[w,F]=r.useState({}),I=t=>{L(!1),a({clientId:0,technicienId:x||1,maintenanceId:0,description_probleme:"",photo_probleme:[],verifications_preliminaires:"",resultat_diagnostic:"",actions_correctives:"",verification_fonctionnement:"",recommandations:"",date_intervention:j}),R(t)},N=t=>{a("photo_probleme",t),w.photo_probleme&&F({...w,photo_probleme:""})},g=()=>{const t={};return o.description_probleme.trim()||(t.description_probleme="Le problème rapporté est obligatoire"),o.verifications_preliminaires.trim()||(t.verifications_preliminaires="Les vérifications préliminaires sont obligatoires"),o.resultat_diagnostic.trim()||(t.resultat_diagnostic="Le résultat du diagnostic est obligatoire"),o.actions_correctives.trim()||(t.actions_correctives="Les actions correctives sont obligatoires"),o.verification_fonctionnement.trim()||(t.verification_fonctionnement="La vérification du fonctionnement est obligatoire"),o.date_intervention||(t.date_intervention="La date d'intervention est obligatoire"),f(t),Object.keys(t).length===0},S=async()=>{if(g()){o.technicienId=x;try{if(v(!0),o.photo_probleme&&Array.isArray(o.photo_probleme)){for(const i of o.photo_probleme)if(i.size>5*1024*1024){d({show:!0,message:`Le fichier ${i.name} est trop volumineux (max 5MB)`,type:"error"});return}}const t=new FormData;t.append("clientId",o.clientId),t.append("technicienId",o.technicienId),t.append("maintenanceId",o.maintenanceId),t.append("description_probleme",o.description_probleme),o.photo_probleme&&Array.isArray(o.photo_probleme)&&o.photo_probleme.length>0&&o.photo_probleme.forEach((i,P)=>{t.append(`photo_probleme[${P}]`,i)}),t.append("verifications_preliminaires",o.verifications_preliminaires),t.append("resultat_diagnostic",o.resultat_diagnostic),t.append("actions_correctives",o.actions_correctives),t.append("verification_fonctionnement",o.verification_fonctionnement),t.append("recommandations",o.recommandations||""),t.append("date_intervention",o.date_intervention);const C=await _e(t);I(C.message)}catch(t){console.error("Erreur lors de la création du rapport:",t),d({show:!0,message:"Une erreur est survenue lors de la création du rapport",type:"error"})}finally{v(!1)}}};return e.jsxs(B,{show:D,closeable:!1,onClose:I,maxWidth:"xl",children:[e.jsx("div",{className:"text-2xl font-semibold text-center",children:"Formulaire rapport maintenance"}),e.jsxs("form",{className:"grid w-full grid-cols-1 gap-4 my-6 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(_,{htmlFor:"description_probleme",value:"Problème rapporté *"}),e.jsx(k,{id:"description_probleme",name:"description_probleme",value:o.description_probleme,className:"block w-full mt-1",autoComplete:"off",onChange:t=>a("description_probleme",t.target.value),required:!0,rows:3,readOnly:!0,onFocus:()=>f({...l,description_probleme:""})}),e.jsx(h,{message:l.description_probleme||w.description_probleme||u.description_probleme,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"verifications_preliminaires",value:"Vérifications préliminaires *"}),e.jsx(k,{id:"verifications_preliminaires",name:"verifications_preliminaires",value:o.verifications_preliminaires,className:"block w-full mt-1",autoComplete:"off",onChange:t=>a("verifications_preliminaires",t.target.value),required:!0,rows:3,onFocus:()=>f({...l,verifications_preliminaires:""})}),e.jsx(h,{message:l.verifications_preliminaires||u.verifications_preliminaires,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"resultat_diagnostic",value:"Résultat du diagnostic *"}),e.jsx(k,{id:"resultat_diagnostic",name:"resultat_diagnostic",value:o.resultat_diagnostic,className:"block w-full mt-1",autoComplete:"off",onChange:t=>a("resultat_diagnostic",t.target.value),required:!0,rows:3,onFocus:()=>f({...l,resultat_diagnostic:""})}),e.jsx(h,{message:l.resultat_diagnostic||u.resultat_diagnostic,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"actions_correctives",value:"Actions correctives *"}),e.jsx(k,{id:"actions_correctives",name:"actions_correctives",value:o.actions_correctives,className:"block w-full mt-1",autoComplete:"off",onChange:t=>a("actions_correctives",t.target.value),required:!0,rows:3,onFocus:()=>f({...l,actions_correctives:""})}),e.jsx(h,{message:l.actions_correctives||u.actions_correctives,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"verification_fonctionnement",value:"Vérification du fonctionnement *"}),e.jsx(k,{id:"verification_fonctionnement",name:"verification_fonctionnement",value:o.verification_fonctionnement,className:"block w-full mt-1",autoComplete:"off",onChange:t=>a("verification_fonctionnement",t.target.value),required:!0,rows:3,onFocus:()=>f({...l,verification_fonctionnement:""})}),e.jsx(h,{message:l.verification_fonctionnement||u.verification_fonctionnement,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"recommandations",value:"Recommandations au Client (optionnel)"}),e.jsx(k,{id:"recommandations",name:"recommandations",value:o.recommandations,className:"block w-full mt-1",autoComplete:"off",onChange:t=>a("recommandations",t.target.value),rows:3,onFocus:()=>f({...l,recommandations:""})}),e.jsx(h,{message:u.recommandations,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"photo_probleme",value:"Photo du problème (optionnel)"}),e.jsx(G,{ref:y,selectedFiles:o.photo_probleme,onLoadFile:N,onFocus:()=>F({...w,photo_probleme:""}),multiple:!0,placeholder:"Sélectionner des photos"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"date_intervention",value:"Date de l'intervention *"}),e.jsx(z,{id:"date_intervention",name:"date_intervention",value:o.date_intervention,className:"block w-full mt-1",autoComplete:"off",onChange:t=>a("date_intervention",t.target.value),type:"date",required:!0,onFocus:()=>f({...l,date_intervention:""})}),e.jsx(h,{message:l.date_intervention||u.date_intervention,className:"mt-2"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-4 px-1",children:[e.jsx("button",{type:"button",className:"px-4 py-1 text-red-500 rounded-md bg-red-400/10",onClick:()=>I(""),children:"Fermer"}),e.jsx("button",{type:"submit",className:`rounded-md py-1 px-4 disabled:cursor-not-allowed bg-blue-500 text-white ${p&&"opacity-25"}`,disabled:p,onClick:S,children:p?"Enregistrement...":"Enregistrer"})]}),e.jsx(H,{show:c.show,message:c.message,type:c.type,onClose:()=>d({...c,show:!1})})]})},Qe=()=>{const[D,L]=r.useState(""),[s,R]=r.useState(0),[x,j]=r.useState(!1),[o,a]=r.useState(!1),[u,p]=r.useState({}),[v,l]=r.useState({}),[f,c]=r.useState(1),[d,y]=r.useState([]),[w,F]=r.useState([]),[I,N]=r.useState(!0),[g,S]=r.useState({open:!1,message:"",id:0}),[t,C]=r.useState({open:!1,message:"",type:"success"}),i=te().props.auth.user,[P,E]=r.useState(10),M=[{key:"id",label:"ID",sortable:!0},{key:"code_installation",label:"Installation",sortable:!0},{key:"nom",label:"Client",sortable:!0},{key:"type_intervention",label:"Type"},{key:"description_probleme",label:"Problème",customRender:n=>e.jsxs("div",{className:"relative max-w-md group",children:[e.jsx("span",{className:"line-clamp-2",children:n}),e.jsx("div",{className:"absolute bottom-0 left-0 z-50 hidden max-w-md p-2 mt-2 text-sm text-gray-800 bg-white border border-gray-300 rounded shadow-md group-hover:block",children:n})]})},{key:"date_intervention",label:"Date d'intervenir",sortable:!0},{key:"status_intervention",label:"Statuts",customRender:n=>e.jsx("span",{className:`px-2 py-1 rounded-full text-white flex text-nowrap ${n==="terminée"?"bg-green-500/50":n==="en attente"?"bg-blue-500/50":"bg-red-500/50"}`,children:n})},{key:"status_intervention",label:"Rapport",sortable:!0,customRender:(n,b)=>{var m,A,q;return e.jsx("span",{onClick:()=>{var $;return n==="terminée"?O.visit("/rapport",{data:{intervention_id:b.id}}):(($=i.user_role)==null?void 0:$.name)==="partenaire"?null:J(b)},className:`px-2 py-1 rounded-full flex text-nowrap ${((m=i.user_role)==null?void 0:m.name)==="partenaire"&&n!=="terminée"?"cursor-default":"cursor-pointer"} ${n==="terminée"?"text-green-500":((A=i.user_role)==null?void 0:A.name)==="partenaire"?"text-gray-300":"text-blue-500"}`,children:n==="terminée"?"Consulter":((q=i.user_role)==null?void 0:q.name)==="partenaire"?"En attente":"Ajouter"})}}],W=[{label:e.jsx(je,{className:"text-lg"}),color:"text-blue-500",hoverColor:"text-blue-600",handler:n=>ee(n)},{label:e.jsx(ge,{className:"text-base"}),color:"text-red-500",hoverColor:"text-red-600",handler:n=>Y(n)}],U=()=>{j(!0)},J=n=>{var b;((b=i.user_role)==null?void 0:b.name)==="partenaire"?O.visit("/rapport",{data:{intervention_id:n.id}}):(a(!0),l(n))},T=async()=>{N(!0);const{data:n}=await ve(),b=n.map(m=>({id:m.id,installation_id:m.installation_id,code_installation:m.installation.code_installation,nom:m.installation.client.nom+" "+m.installation.client.prenom,idclient:m.installation.client.id,type_intervention:m.type_intervention,description_probleme:m.description_probleme,status_intervention:m.status_intervention,date_intervention:me(m.date_intervention)}));y(b),F(b),N(!1)};r.useEffect(()=>{T()},[]);const K=n=>{L(n),c(1);const b=d.filter(m=>m.nom.toLowerCase().includes(n.toLowerCase())||m.type_intervention.toLowerCase().includes(n.toLowerCase())||m.description_probleme.toLowerCase().includes(n.toLowerCase())||m.date_intervention.toString().toLowerCase().includes(n.toLowerCase()));F(b)},Q=n=>{T(),n&&C({...t,message:n,open:!0}),p({})},X=n=>{T(),n&&C({...t,message:n,open:!0}),l({})},Y=n=>{S({open:!0,message:`Êtes-vous sûr de vouloir supprimer l'intervention du ${n.nom} le ${n.date_intervention} ?`,id:n.id})},Z=async()=>{const{message:n}=await fe(g.id);C({...t,message:n,open:!0}),S({...g,open:!1,id:0}),T(),c(1)},ee=n=>{const b=n.date_intervention?n.date_intervention:"Invalid date";p({...n,date_intervention:pe(b)}),j(!0)};return e.jsxs(xe,{setId:R,children:[e.jsx(ne,{title:"Maintenance"}),e.jsx(se,{search:D,onSearch:K,title:`Liste des interventions ( Total: ${d.length} )`,handleClick:U}),e.jsx(H,{message:t.message,type:t.type,duration:3e3,position:"top-right",show:t.open,onClose:()=>C({...t,message:"",open:!1})}),e.jsx(oe,{open:g.open,message:g.message,btnAcceptName:"Supprimer",title:"Suppression",btnAcceptColor:"bg-red-500 text-white",close:()=>S({...g,open:!1}),accept:Z}),e.jsx(ye,{open:x,setOpen:j,dataModify:u,onCloseFormulaire:Q,idTechnicien:s}),e.jsx(we,{open:o,setOpen:a,dataModify:v,onCloseFormulaire:X,idTechnicien:s}),I?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"w-12 h-12 border-t-2 border-b-2 border-blue-500 rounded-full animate-spin"})}):e.jsx("div",{children:w.length>0?e.jsx(ie,{headers:M,rows:w,itemsPerPage:P,actions:W,className:"mt-4",currentPage:f,onPageChange:c,masqueColumns:["client_id"],onItemsPerPageChange:n=>E(n)}):e.jsx(re,{nom:"intervention",search:D})})]})};export{Qe as default};
