import{r,v as O,j as e}from"./app-4wEmdYjz.js";import{M as A}from"./Modal-bs1AMDwt.js";import{I as d,T as _}from"./TextInput-CO5S_b65.js";import{I as p}from"./InputLabel-ET58zQnd.js";import{f as B}from"./validateForm-f9K0gDaZ.js";import{g as U,c as W,u as z}from"./installationService-CV6jRSBU.js";import{I as H}from"./InputAutocomplete -BVzY1QBt.js";import{b as K}from"./clientService-Bim-z46b.js";import{r as G}from"./constant-B_m1A7JV.js";import{S as J}from"./SelectInput-C0OAjYZh.js";async function Q(C,j){try{const x=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${C}&lon=${j}&zoom=18&addressdetails=1`)).json(),l=x.address;return{village:l.village||l.town||l.city||l.hamlet||"Non trouvé",adresse:x.display_name||"Adresse non trouvée",pays:l.country||"Pays non trouvé",region:l.state||l.region||l.county||"Région non trouvée",code_postal:l.postcode||"Code postal non trouvé",rue:l.road||l.street||"Rue non trouvée",code_pays:l.country_code?l.country_code.toUpperCase():"Code pays non trouvé"}}catch{return{village:"Erreur",adresse:"Erreur lors de la récupération",pays:"Erreur",region:"Erreur",code_postal:"Erreur",rue:"Erreur",code_pays:"Erreur"}}}const ne=({open:C=!0,setOpen:j,dataModify:s={},onCloseFormulaire:x=()=>{},token_data:l})=>{const[w,b]=r.useState("Enregistrer"),[E,y]=r.useState(!1),[n,f]=r.useState({}),[T,V]=r.useState([]),[X,k]=r.useState(!1),{data:a,setData:i,errors:c}=O({client_id:0,date_installation:new Date().toISOString().split("T")[0],puissance_pompe:"",profondeur_forage:"",debit_nominal:"",numero_serie:"",code_installation:"",source_eau:"Puits",hmt:"",latitude:"",longitude:"",pays:"",ville:"",statuts:"installée",created_via:l?"telegram_bot":"web"}),I=r.useCallback(t=>{if(!t||t.length===0)return"I0001";const h=t.reduce((u,v)=>{var P;const L=(P=v.code_installation)==null?void 0:P.match(/I(\d+)/);if(L){const D=parseInt(L[1],10);return D>u?D:u}return u},0)+1;return`I${String(h).padStart(4,"0")}`},[]),S=r.useCallback(async()=>{try{const[{clients:t},m]=await Promise.all([K(),U()]),h=t.filter(v=>v.is_payed!==!1).map(v=>({id:v.id,nom:`${v.nom} ${v.prenom}`})),u=I(m.data);V(h),s.id||i("code_installation",u)}catch(t){console.error("Error fetching clients and installations:",t)}},[s.id,i,I]),N=r.useCallback(t=>{j(!1),F(),x(t)},[j,x]),F=r.useCallback(()=>{i({client_id:0,date_installation:new Date().toISOString().split("T")[0],puissance_pompe:"",profondeur_forage:"",debit_nominal:"",numero_serie:"",code_installation:"I0001",source_eau:"Puits",hmt:"",latitude:"",longitude:"",pays:"",ville:"",statuts:"installée"}),y(!1),b("Enregistrer"),f({})},[i]),o=r.useCallback(t=>{f(m=>({...m,[t]:""}))},[]);r.useEffect(()=>{var t,m;S(),s.id?(i({client_id:s.client_id||0,date_installation:G(s.date_installation)||new Date().toISOString().split("T")[0],puissance_pompe:s.puissance_pompe||"",profondeur_forage:s.profondeur_forage||"",debit_nominal:s.debit_nominal||"",numero_serie:s.numero_serie||"",code_installation:s.code_installation||"",source_eau:s.source_eau||"Puits",hmt:s.hmt||"",ville:((t=s.localisation)==null?void 0:t.ville)||"Kara",pays:((m=s.localisation)==null?void 0:m.pays)||"Togo",latitude:s.latitude||"",longitude:s.longitude||"",statuts:s.statuts||"installée"}),b("Modifier")):F()},[s,i,S,F]);const q=r.useCallback(async()=>{if(!a.latitude||!a.longitude){console.warn("Latitude and longitude are required for location lookup");return}k(!0);try{const t=await Q(a.latitude,a.longitude);i("ville",t.region||t.village||t.adresse||prev.ville),i("pays",t.pays)}catch(t){console.error("Error getting location:",t)}finally{k(!1)}},[a.latitude,a.longitude,i]),$=async()=>{var m,h;const t=w==="Enregistrer";if(!(t&&!B(a,f))){y(!0),b("Chargement...");try{let u;t?{message:u}=await W(a):{message:u}=await z(s.id,a),N(u)}catch(u){console.error("Error submitting installation:",u),(h=(m=u.response)==null?void 0:m.data)!=null&&h.errors?f(u.response.data.errors):f({general:"Une erreur est survenue lors de la soumission du formulaire."})}finally{y(!1),b(t?"Enregistrer":"Modifier")}}};r.useEffect(()=>{a.latitude&&a.longitude&&q()},[a.latitude,a.longitude,q]);const R=r.useCallback(t=>{i("client_id",t.id),o("client_id")},[i,o]),g=r.useCallback((t,m)=>{i(t,m),o(t)},[i,o]);return e.jsxs(A,{show:C,closeable:!1,onClose:N,maxWidth:"4xl",children:[e.jsx("div",{className:"text-2xl font-semibold text-center",children:s.id?"Modifier une Installation":"Ajouter une Installation"}),n.general&&e.jsx("div",{className:"p-3 mt-4 text-red-700 bg-red-100 border border-red-300 rounded",children:n.general}),e.jsxs("form",{className:"grid w-full grid-cols-1 gap-4 my-6 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx(p,{htmlFor:"client_id",value:"Nom client"}),e.jsx(H,{data:T,className:"block w-full mt-1",onSelect:R,defaultValue:a.client_id??0,onFocus:()=>o("client_id")}),e.jsx(d,{message:n.client_id||c.client_id,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(p,{htmlFor:"numero_serie",value:"Numéro de série de la pompe"}),e.jsx(_,{id:"numero_serie",name:"numero_serie",value:a.numero_serie,className:"block w-full mt-1",autoComplete:"numero_serie",onChange:t=>g("numero_serie",t.target.value),required:!0,onFocus:()=>o("numero_serie")}),e.jsx(d,{message:n.numero_serie||c.numero_serie,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(p,{htmlFor:"source_eau",value:"Source d'eau"}),e.jsxs(J,{id:"source_eau",name:"source_eau",value:a.source_eau,className:"block w-full mt-1",autoComplete:"source_eau",onChange:t=>g("source_eau",t.target.value),required:!0,children:[e.jsx("option",{value:"Puits",children:"Puits"}),e.jsx("option",{value:"Forage",children:"Forage"}),e.jsx("option",{value:"Etang",children:"Etang"}),e.jsx("option",{value:"Barrage",children:"Barrage"}),e.jsx("option",{value:"Rivière",children:"Rivière"})]}),e.jsx(d,{message:n.source_eau||c.source_eau,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(p,{htmlFor:"hmt",value:"HMT (m)"}),e.jsx(_,{id:"hmt",name:"hmt",value:a.hmt,className:"block w-full mt-1",autoComplete:"hmt",onChange:t=>g("hmt",t.target.value),required:!0,type:"number",onFocus:()=>o("hmt")}),e.jsx(d,{message:n.hmt||c.hmt,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(p,{htmlFor:"profondeur_forage",value:"Distance maximale pompe champ PV (m)"}),e.jsx(_,{id:"profondeur_forage",name:"profondeur_forage",value:a.profondeur_forage,className:"block w-full mt-1",autoComplete:"profondeur_forage",onChange:t=>g("profondeur_forage",t.target.value),required:!0,type:"number",onFocus:()=>o("profondeur_forage")}),e.jsx(d,{message:n.profondeur_forage||c.profondeur_forage,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(p,{htmlFor:"debit_nominal",value:"Débit nominal (m³/h)"}),e.jsx(_,{id:"debit_nominal",name:"debit_nominal",value:a.debit_nominal,className:"block w-full mt-1",autoComplete:"debit_nominal",onChange:t=>g("debit_nominal",t.target.value),required:!0,type:"number",onFocus:()=>o("debit_nominal")}),e.jsx(d,{message:n.debit_nominal||c.debit_nominal,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(p,{htmlFor:"puissance_pompe",value:"Puissance crête installé (W)"}),e.jsx(_,{id:"puissance_pompe",name:"puissance_pompe",value:a.puissance_pompe,className:"block w-full mt-1",autoComplete:"puissance_pompe",onChange:t=>g("puissance_pompe",t.target.value),required:!0,type:"number",onFocus:()=>o("puissance_pompe")}),e.jsx(d,{message:n.puissance_pompe||c.puissance_pompe,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(p,{htmlFor:"latitude",value:"Latitude"}),e.jsx(_,{id:"latitude",name:"latitude",value:a.latitude,className:"block w-full mt-1",autoComplete:"latitude",type:"number",step:"any",onChange:t=>g("latitude",t.target.value),onFocus:()=>o("latitude")}),e.jsx(d,{message:n.latitude||c.latitude,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(p,{htmlFor:"longitude",value:"Longitude"}),e.jsx(_,{id:"longitude",name:"longitude",value:a.longitude,className:"block w-full mt-1",autoComplete:"longitude",type:"number",step:"any",onChange:t=>g("longitude",t.target.value),onFocus:()=>o("longitude")}),e.jsx(d,{message:n.longitude||c.longitude,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(p,{htmlFor:"pays",value:"Pays"}),e.jsx(_,{id:"pays",name:"pays",value:a.pays,readOnly:!0,className:"block w-full mt-1",autoComplete:"pays",onChange:t=>g("pays",t.target.value),required:!0,onFocus:()=>o("pays")}),e.jsx(d,{message:n.pays||c.pays,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(p,{htmlFor:"ville",value:"Ville"}),e.jsx(_,{id:"ville",name:"ville",value:a.ville,readOnly:!0,className:"block w-full mt-1",autoComplete:"ville",onChange:t=>g("ville",t.target.value),required:!0,onFocus:()=>o("ville")}),e.jsx(d,{message:n.ville||c.ville,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(p,{htmlFor:"date_installation",value:"Date de l'installation"}),e.jsx(_,{id:"date_installation",name:"date_installation",value:a.date_installation,className:"block w-full mt-1",autoComplete:"date_installation",type:"date",onChange:t=>g("date_installation",t.target.value),required:!0,onFocus:()=>o("date_installation")}),e.jsx(d,{message:n.date_installation||c.date_installation,className:"mt-2"})]})]}),e.jsx("div",{className:"flex items-center justify-end px-1",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{type:"button",className:"px-4 py-2 text-red-500 rounded-md bg-red-400/10 hover:bg-red-400/20",onClick:()=>N(""),children:"Fermer"}),e.jsx("button",{type:"submit",className:`rounded-md py-2 px-4 disabled:cursor-not-allowed bg-blue-500 text-white hover:bg-blue-600 ${E&&"opacity-50"}`,disabled:E,onClick:$,children:w})]})})]})};export{ne as F};
