import{r as u,v as Q,j as t}from"./app-BinU7nh5.js";import{M as U}from"./Modal-D7sCRa1e.js";import{I as p,T as x}from"./TextInput-YJDn3mPB.js";import{I as m}from"./InputLabel-C4IRUL8v.js";import{g as W,c as H,u as G}from"./installationService-BFspxwIY.js";import{I as J}from"./InputAutocomplete -DcrtNpxt.js";import{b as X}from"./clientService-CXWDmTpe.js";import{z as Y}from"./constant-BMumjB3X.js";import{S as Z}from"./SelectInput-CEaKZesC.js";import{I as D}from"./InputImage-Bt9Qb0zT.js";async function M(C,f){try{const b=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${C}&lon=${f}&zoom=18&addressdetails=1`)).json(),i=b.address;return{village:i.village||i.town||i.city||i.hamlet||"Non trouvé",adresse:b.display_name||"Adresse non trouvée",pays:i.country||"Pays non trouvé",region:i.state||i.region||i.county||"Région non trouvée",code_postal:i.postcode||"Code postal non trouvé",rue:i.road||i.street||"Rue non trouvée",code_pays:i.country_code?i.country_code.toUpperCase():"Code pays non trouvé"}}catch{return{village:"Erreur",adresse:"Erreur lors de la récupération",pays:"Erreur",region:"Erreur",code_postal:"Erreur",rue:"Erreur",code_pays:"Erreur"}}}const ce=({open:C=!0,setOpen:f,dataModify:n={},onCloseFormulaire:b=()=>{},token_data:i})=>{const[I,F]=u.useState("Enregistrer"),[E,N]=u.useState(!1),[r,j]=u.useState({}),[P,$]=u.useState([]),[R,k]=u.useState(!1),V=u.useRef(null),{data:a,setData:_,errors:c}=Q({client_id:"",date_installation:new Date().toISOString().split("T")[0],puissance_pompe:"",profondeur_forage:"",debit_nominal:"",numero_serie:"",code_installation:"",source_eau:"Puits",hmt:"",latitude:"",longitude:"",pays:"",ville:"",statuts:"installée",photos_installation:[],qte_eau:"",qte_co2:""}),L=u.useCallback(e=>{if(!e||e.length===0)return"I0001";const d=e.reduce((g,s)=>{var q;const v=(q=s.code_installation)==null?void 0:q.match(/I(\d+)/);if(v){const T=parseInt(v[1],10);return T>g?T:g}return g},0)+1;return`I${String(d).padStart(4,"0")}`},[]),O=u.useCallback(async()=>{try{const[{clients:e},o]=await Promise.all([X(),W()]),d=e.filter(s=>s.is_payed!==!1).map(s=>({id:s.id,nom:`${s.nom} ${s.prenom}`})),g=L(o.data);$(d),n.id||_("code_installation",g)}catch(e){console.error("Error fetching clients and installations:",e)}},[n.id,_,L]),y=u.useCallback(e=>{f(!1),w(),b(e)},[f,b]),w=u.useCallback(()=>{_({client_id:"",date_installation:new Date().toISOString().split("T")[0],puissance_pompe:"",profondeur_forage:"",debit_nominal:"",numero_serie:"",code_installation:"I0001",source_eau:"Puits",hmt:"",latitude:"",longitude:"",pays:"",ville:"",statuts:"installée",photos_installation:[],qte_eau:"",qte_co2:""}),N(!1),F("Enregistrer"),j({})},[_]),l=u.useCallback(e=>{j(o=>({...o,[e]:""}))},[]);u.useEffect(()=>{var e,o;O(),n.id?(_({client_id:n.client_id||"",date_installation:Y(n.date_installation)||new Date().toISOString().split("T")[0],puissance_pompe:n.puissance_pompe||"",profondeur_forage:n.profondeur_forage||"",debit_nominal:n.debit_nominal||"",numero_serie:n.numero_serie||"",code_installation:n.code_installation||"",source_eau:n.source_eau||"Puits",hmt:n.hmt||"",ville:((e=n.localisation)==null?void 0:e.ville)||"Kara",pays:((o=n.localisation)==null?void 0:o.pays)||"Togo",latitude:n.latitude||"",longitude:n.longitude||"",statuts:n.statuts||"installée",photos_installation:n.photos_installation||[],created_via:n.created_via||"web",qte_eau:n.qte_eau||0,qte_co2:n.qte_co2||0}),F("Modifier")):w()},[n,_,w]);const S=u.useCallback(async(e,o)=>{if(!e||!o){console.warn("Latitude and longitude are required for location lookup");return}k(!0);try{const d=await M(e,o);_(g=>({...g,ville:d.region||d.village||d.adresse||g.ville,pays:d.pays||g.pays}))}catch(d){console.error("Error getting location:",d)}finally{k(!1)}},[_]),A=e=>{const o={};return(!e.client_id||e.client_id===""||e.client_id===0)&&(o.client_id="Veuillez sélectionner un client"),["puissance_pompe","profondeur_forage","debit_nominal","hmt"].forEach(s=>{!e[s]||e[s]===""?o[s]=`Le champ ${s} est requis`:(isNaN(e[s])||parseFloat(e[s])<=0)&&(o[s]=`Le champ ${s} doit être un nombre positif`)}),["numero_serie","code_installation"].forEach(s=>{(!e[s]||e[s].trim()==="")&&(o[s]=`Le champ ${s} est requis`)}),!e.latitude||e.latitude===""?o.latitude="La latitude est requise":(isNaN(e.latitude)||parseFloat(e.latitude)<-90||parseFloat(e.latitude)>90)&&(o.latitude="La latitude doit être comprise entre -90 et 90"),!e.longitude||e.longitude===""?o.longitude="La longitude est requise":(isNaN(e.longitude)||parseFloat(e.longitude)<-180||parseFloat(e.longitude)>180)&&(o.longitude="La longitude doit être comprise entre -180 et 180"),e.date_installation?new Date(e.date_installation)>new Date&&(o.date_installation="La date d'installation ne peut pas être dans le futur"):o.date_installation="La date d'installation est requise",(!e.qte_co2||e.qte_co2===0)&&(o.qte_co2="La quantité de CO2 evité est requise"),(!e.qte_eau||e.qte_eau===0)&&(o.qte_eau="La quantité d'eau pompée est requise"),{isValid:Object.keys(o).length===0,errors:o}},z=async()=>{var d,g;const e=I==="Enregistrer",o=A(a);if(!o.isValid){j(o.errors);return}N(!0),F("Chargement...");try{let s;Array.isArray(a.photos_installation)&&a.photos_installation.length>0?(s=new FormData,s.append("client_id",parseInt(a.client_id)),s.append("date_installation",a.date_installation),s.append("puissance_pompe",parseFloat(a.puissance_pompe)),s.append("profondeur_forage",parseFloat(a.profondeur_forage)),s.append("debit_nominal",parseFloat(a.debit_nominal)),s.append("numero_serie",a.numero_serie),s.append("code_installation",a.code_installation),s.append("source_eau",a.source_eau),s.append("hmt",parseFloat(a.hmt)),s.append("latitude",parseFloat(a.latitude)),s.append("longitude",parseFloat(a.longitude)),s.append("pays",a.pays||""),s.append("ville",a.ville||""),s.append("statuts",a.statuts),s.append("created_via",i?"telegram_bot":"web"),a.photos_installation.forEach(q=>{s.append("photos_installation[]",q)}),s.append("qte_co2",parseFloat(a.qte_co2)),s.append("qte_eau",parseFloat(a.qte_eau))):s={client_id:parseInt(a.client_id),date_installation:a.date_installation,puissance_pompe:parseFloat(a.puissance_pompe),profondeur_forage:parseFloat(a.profondeur_forage),debit_nominal:parseFloat(a.debit_nominal),numero_serie:a.numero_serie,code_installation:a.code_installation,source_eau:a.source_eau,hmt:parseFloat(a.hmt),latitude:parseFloat(a.latitude),longitude:parseFloat(a.longitude),pays:a.pays||"",ville:a.ville||"",statuts:a.statuts,created_via:i?"telegram_bot":"web",qte_co2:parseFloat(a.qte_co2),qte_eau:parseFloat(a.qte_eau)};let v;e?{message:v}=await H(s):{message:v}=await G(n.id,s),y(v)}catch(s){console.error("Error submitting installation:",s),(g=(d=s.response)==null?void 0:d.data)!=null&&g.errors?j(s.response.data.errors):j({general:"Une erreur est survenue lors de la soumission."})}finally{N(!1),F(e?"Enregistrer":"Modifier")}};u.useEffect(()=>{const e=setTimeout(()=>{a.latitude&&a.longitude&&S(a.latitude,a.longitude)},500);return()=>clearTimeout(e)},[a.latitude,a.longitude,S]);const B=u.useCallback(e=>{_("client_id",e.id),l("client_id")},[_,l]),h=u.useCallback((e,o)=>{_(e,o),l(e)},[_,l]),K=e=>{_(o=>({...o,photos_installation:e})),l("photos_installation")};return t.jsxs(U,{show:C,closeable:!1,onClose:y,maxWidth:"4xl",children:[t.jsx("div",{className:"text-2xl font-semibold text-center",children:n.id?"Modifier une Installation":"Ajouter une Installation"}),r.general&&t.jsx("div",{className:"p-3 mt-4 text-red-700 bg-red-100 border border-red-300 rounded",children:r.general}),t.jsxs("form",{className:"grid w-full grid-cols-1 gap-4 my-6 sm:grid-cols-3",children:[t.jsxs("div",{children:[t.jsx(m,{htmlFor:"client_id",value:"Nom client *"}),t.jsx(J,{data:P,className:"block w-full mt-1",onSelect:B,defaultValue:a.client_id??"",onFocus:()=>l("client_id")}),t.jsx(p,{message:r.client_id||c.client_id,className:"mt-2"})]}),t.jsxs("div",{children:[t.jsx(m,{htmlFor:"numero_serie",value:"Numéro de série de la pompe *"}),t.jsx(x,{id:"numero_serie",name:"numero_serie",value:a.numero_serie,className:"block w-full mt-1",autoComplete:"numero_serie",onChange:e=>h("numero_serie",e.target.value),required:!0,onFocus:()=>l("numero_serie")}),t.jsx(p,{message:r.numero_serie||c.numero_serie,className:"mt-2"})]}),t.jsxs("div",{children:[t.jsx(m,{htmlFor:"source_eau",value:"Source d'eau *"}),t.jsxs(Z,{id:"source_eau",name:"source_eau",value:a.source_eau,className:"block w-full mt-1",autoComplete:"source_eau",onChange:e=>h("source_eau",e.target.value),required:!0,children:[t.jsx("option",{value:"Puits",children:"Puits"}),t.jsx("option",{value:"Forage",children:"Forage"}),t.jsx("option",{value:"Etang",children:"Etang"}),t.jsx("option",{value:"Barrage",children:"Barrage"}),t.jsx("option",{value:"Rivière",children:"Rivière"})]}),t.jsx(p,{message:r.source_eau||c.source_eau,className:"mt-2"})]}),t.jsxs("div",{children:[t.jsx(m,{htmlFor:"hmt",value:"HMT (m) *"}),t.jsx(x,{id:"hmt",name:"hmt",value:a.hmt,className:"block w-full mt-1",autoComplete:"hmt",onChange:e=>h("hmt",e.target.value),required:!0,type:"number",min:"0",step:"0.01",onFocus:()=>l("hmt")}),t.jsx(p,{message:r.hmt||c.hmt,className:"mt-2"})]}),t.jsxs("div",{children:[t.jsx(m,{htmlFor:"profondeur_forage",value:"Distance maximale pompe champ PV (m) *"}),t.jsx(x,{id:"profondeur_forage",name:"profondeur_forage",value:a.profondeur_forage,className:"block w-full mt-1",autoComplete:"profondeur_forage",onChange:e=>h("profondeur_forage",e.target.value),required:!0,type:"number",min:"0",step:"0.01",onFocus:()=>l("profondeur_forage")}),t.jsx(p,{message:r.profondeur_forage||c.profondeur_forage,className:"mt-2"})]}),t.jsxs("div",{children:[t.jsx(m,{htmlFor:"debit_nominal",value:"Débit nominal (m³/h) *"}),t.jsx(x,{id:"debit_nominal",name:"debit_nominal",value:a.debit_nominal,className:"block w-full mt-1",autoComplete:"debit_nominal",onChange:e=>h("debit_nominal",e.target.value),required:!0,type:"number",min:"0",step:"0.01",onFocus:()=>l("debit_nominal")}),t.jsx(p,{message:r.debit_nominal||c.debit_nominal,className:"mt-2"})]}),t.jsxs("div",{children:[t.jsx(m,{htmlFor:"puissance_pompe",value:"Puissance crête installé (W) *"}),t.jsx(x,{id:"puissance_pompe",name:"puissance_pompe",value:a.puissance_pompe,className:"block w-full mt-1",autoComplete:"puissance_pompe",onChange:e=>h("puissance_pompe",e.target.value),required:!0,type:"number",min:"0",step:"0.01",onFocus:()=>l("puissance_pompe")}),t.jsx(p,{message:r.puissance_pompe||c.puissance_pompe,className:"mt-2"})]}),t.jsxs("div",{children:[t.jsx(m,{htmlFor:"qte_eau",value:"Quantité d'eau pompée (m³) *"}),t.jsx(x,{id:"qte_eau",name:"qte_eau",value:a.qte_eau,className:"block w-full mt-1",autoComplete:"qte_eau",onChange:e=>h("qte_eau",e.target.value),required:!0,type:"number",min:"0",onFocus:()=>l("qte_eau")}),t.jsx(p,{message:r.qte_eau||c.qte_eau,className:"mt-2"})]}),t.jsxs("div",{children:[t.jsx(m,{htmlFor:"qte_co2",value:"Quantité de CO2 evité (Kg) *"}),t.jsx(x,{id:"qte_co2",name:"qte_co2",value:a.qte_co2,className:"block w-full mt-1",autoComplete:"qte_co2",onChange:e=>h("qte_co2",e.target.value),required:!0,type:"number",min:"0",onFocus:()=>l("qte_co2")}),t.jsx(p,{message:r.qte_co2||c.qte_co2,className:"mt-2"})]}),t.jsxs("div",{children:[t.jsx(m,{htmlFor:"latitude",value:"Latitude *"}),t.jsx(x,{id:"latitude",name:"latitude",value:a.latitude,className:"block w-full mt-1",autoComplete:"latitude",type:"number",step:"any",min:"-90",max:"90",onChange:e=>h("latitude",e.target.value),onFocus:()=>l("latitude"),required:!0}),t.jsx(p,{message:r.latitude||c.latitude,className:"mt-2"})]}),t.jsxs("div",{children:[t.jsx(m,{htmlFor:"longitude",value:"Longitude *"}),t.jsx(x,{id:"longitude",name:"longitude",value:a.longitude,className:"block w-full mt-1",autoComplete:"longitude",type:"number",step:"any",min:"-180",max:"180",onChange:e=>h("longitude",e.target.value),onFocus:()=>l("longitude"),required:!0}),t.jsx(p,{message:r.longitude||c.longitude,className:"mt-2"})]}),t.jsxs("div",{children:[t.jsx(m,{htmlFor:"pays",value:"Localisation"}),t.jsx(x,{id:"pays",name:"pays",value:a.pays+", "+a.ville,readOnly:!0,className:"block w-full mt-1 bg-gray-50",autoComplete:"pays"}),R&&t.jsx("p",{className:"mt-1 text-sm text-blue-500",children:"Recherche de la localisation..."}),t.jsx(p,{message:r.pays||c.pays,className:"mt-2"})]}),t.jsxs("div",{className:"md:col-span-2",children:[t.jsx(m,{htmlFor:"photos_installation",value:"Photo de l'installation"}),t.jsx(D,{ref:V,selectedFiles:a.photos_installation,onLoadFile:K,onFocus:()=>l("photos_installation"),multiple:!0,placeholder:"Sélectionner une photo"}),t.jsx(p,{message:r.photos_installation||c.photos_installation,className:"mt-2"})]}),t.jsxs("div",{children:[t.jsx(m,{htmlFor:"date_installation",value:"Date de l'installation *"}),t.jsx(x,{id:"date_installation",name:"date_installation",value:a.date_installation,className:"block w-full mt-1",autoComplete:"date_installation",type:"date",max:new Date().toISOString().split("T")[0],onChange:e=>h("date_installation",e.target.value),required:!0,onFocus:()=>l("date_installation")}),t.jsx(p,{message:r.date_installation||c.date_installation,className:"mt-2"})]})]}),t.jsx("div",{className:"flex items-center justify-end px-1",children:t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsx("button",{type:"button",className:"px-4 py-2 text-red-500 rounded-md bg-red-400/10 hover:bg-red-400/20",onClick:()=>y(""),children:"Fermer"}),t.jsx("button",{type:"submit",className:`rounded-md py-2 px-4 disabled:cursor-not-allowed bg-blue-500 text-white hover:bg-blue-600 ${E&&"opacity-50"}`,disabled:E,onClick:z,children:I})]})})]})};export{ce as F};
