import{r as l,v as A,j as e}from"./app-BwaIdyLA.js";import{M as O}from"./Modal-DSCtLdl7.js";import{I as c,T as q}from"./TextInput-CdY3K8JY.js";import{I as d}from"./InputLabel-DKUoQZZ5.js";import{g as L}from"./installationService-C-MSKzxt.js";import{I as P}from"./InputAutocomplete -B6CYjlG0.js";import{z as R}from"./constant-Df1OZiQy.js";import{c as k,u as V}from"./maintenanceService-DkTNloNt.js";import{S as z}from"./SelectInput-Cr6SyeeS.js";import{e as B}from"./validateForm-DkOh89YH.js";import{T as W}from"./TextArea-DBumrpHn.js";import{I as $}from"./InputImage-DQTdr_oR.js";const oe=({open:g=!0,setOpen:j,dataModify:i={},onCloseFormulaire:F=()=>{},idTechnicien:u,token_data:I})=>{const[x,_]=l.useState("Enregistrer"),[h,v]=l.useState(!1),[r,a]=l.useState({}),[w,N]=l.useState([]),{data:o,setData:s,errors:m,reset:E}=A({installation_id:0,date_intervention:new Date().toISOString().split("T")[0],type_intervention:"préventive",description_probleme:"",solutions_apportees:"",duree_intervention:"",technicien:u,photo_probleme:[]}),y=l.useRef(null),S=async()=>{const[{data:t}]=await Promise.all([L()]),n=t.filter(p=>p.statuts!=="en panne").map(p=>({id:p.id,nom:p.code_installation}));N(n)},b=t=>{j(!1),f(),F(t)},f=()=>{E(),v(!1),_("Enregistrer"),a({})};l.useEffect(()=>{S(),i.id?(s({installation_id:i.installation_id||0,date_intervention:R(i.date_intervention)||new Date().toISOString().split("T")[0],type_intervention:i.type_intervention||"",description_probleme:i.description_probleme||"",solutions_apportees:i.solutions_apportees||"",duree_intervention:i.duree_intervention||"",technicien:i.technicien_id||0}),_("Modifier")):f()},[i,s]),l.useEffect(()=>{u&&s("technicien",u)},[u,s]);const C=async()=>{if(!B(o,a))return;o.created_via=I?"telegram_bot":"web";const t=new FormData;Object.keys(o).forEach(n=>{n==="photo_probleme"?Array.isArray(o[n])&&o[n].length>0&&o[n].forEach((p,G)=>{t.append("photo_probleme[]",p)}):t.append(n,o[n])}),v(!0),_("Chargement...");try{let n;x==="Enregistrer"?{message:n}=await k(t):{message:n}=await V(i.id,t),b(n)}catch(n){console.error("Error submitting payment:",n)}finally{v(!1),_("Enregistrer")}},D=t=>{s({...o,installation_id:t.id,description_probleme:t.message})},T=t=>{s("photo_probleme",t),r.photo_probleme&&a({...r,photo_probleme:""})};return e.jsxs(O,{show:g,closeable:!1,onClose:b,maxWidth:"4xl",children:[e.jsx("div",{className:"text-2xl font-semibold text-center",children:i.nom?"Modifier une Intervention":"Ajouter une Intervention"}),e.jsxs("form",{className:"grid w-full grid-cols-1 gap-4 px-6 my-6 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(d,{htmlFor:"installation_id",value:"Code d'instalation"}),e.jsx(P,{data:w,className:"block w-full mt-1",onSelect:D,defaultValue:o.installation_id,readOnly:i.id,onFocus:()=>a({...r,installation_id:""})}),e.jsx(c,{message:r.installation_id||m.installation_id,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(d,{htmlFor:"type_intervention",value:"Type d'intervention"}),e.jsxs(z,{id:"type_intervention",type:"type_intervention",name:"type_intervention",value:o.type_intervention,className:"block w-full mt-1",autoComplete:"type_intervention",onChange:t=>s("type_intervention",t.target.value),required:!0,children:[e.jsx("option",{value:"préventive",children:"Préventive"}),e.jsx("option",{value:"curative",children:"Curative"})]}),e.jsx(c,{message:m.email,className:"mt-2"})]}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx(d,{htmlFor:"description_probleme",value:"Description du problème"}),e.jsx(W,{id:"description_probleme",name:"description_probleme",value:o.description_probleme,className:"block w-full mt-1",autoComplete:"description_probleme",onChange:t=>s("description_probleme",t.target.value),required:!0,rows:4,onFocus:()=>a({...r,description_probleme:""})}),e.jsx(c,{message:r.description_probleme||m.description_probleme,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(d,{htmlFor:"solutions_apportees",value:"Photo du problème"}),e.jsx($,{ref:y,selectedFiles:o.photo_probleme,onLoadFile:T,onFocus:()=>a({...r,photo_probleme:""}),multiple:!0,placeholder:"Sélectionner des photos"}),e.jsx(c,{message:r.photo_probleme||m.photo_probleme,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(d,{htmlFor:"date_intervention",value:"Date d'intervention"}),e.jsx(q,{id:"date_intervention",name:"date_intervention",value:o.date_intervention,className:"block w-full mt-1",autoComplete:"date_intervention",type:"date",onChange:t=>s("date_intervention",t.target.value),required:!0,onFocus:()=>a({...r,date_intervention:""})}),e.jsx(c,{message:r.date_intervention||m.date_intervention,className:"mt-2"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-4 px-6",children:[e.jsx("button",{type:"button",className:"px-4 py-1 text-red-500 rounded-md bg-red-400/10",onClick:()=>b(""),children:"Fermer"}),e.jsx("button",{type:"submit",className:`rounded-md py-1 px-4 disabled:cursor-not-allowed bg-blue-500 text-white ${h&&"opacity-25"}`,disabled:h,onClick:C,children:x})]})]})};export{oe as F};
