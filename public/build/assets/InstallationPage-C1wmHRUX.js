import{r as n,v as O,j as e,$ as H}from"./app-D-Msguey.js";import{C as W}from"./ConfirmDialog-B3pI7AOS.js";import{D as B}from"./DataTable-IqBTd-Eu.js";import{H as G}from"./HeaderPage-fxkogYHJ.js";import{M as U}from"./Modal-Dj6VuHeP.js";import{I as g,T as h}from"./TextInput-DxwFrn0K.js";import{I as _}from"./InputLabel-BuZNzSG6.js";import{b as z}from"./validateForm-CYV7VTEV.js";import{g as V,c as K,u as J,d as Q}from"./installationService-C8A4p6QH.js";import{I as X}from"./InputAutocomplete -CVaMQe34.js";import{b as Y}from"./clientService-3AlaedjY.js";import{p as Z,f as M,q as ee}from"./constant-3wDyiK4X.js";import{S as te}from"./SelectInput-BaIfJNCZ.js";import{S as ae}from"./Snackbar-B-sLl9kM.js";import{A as se,R as oe}from"./AuthenticatedLayout-Bw4RC58Y.js";import{G as ne}from"./index-B_8oXTJW.js";import{T as le,a as re}from"./index-CAPDwIcR.js";import{E as ie}from"./EmptyState-Ct5Sk4pD.js";import"./index-pZmJ4psc.js";import"./iconBase-CBus6TuK.js";import"./transition-D6kUAclv.js";import"./createLucideIcon-DqXJoUaS.js";import"./api-DIg4nFRg.js";import"./useTheme-DYp9nMDG.js";async function ue(j,C){try{const x=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${j}&lon=${C}&zoom=18&addressdetails=1`)).json(),u=x.address;return{village:u.village||u.town||u.city||u.hamlet||"Non trouvé",adresse:x.display_name||"Adresse non trouvée",pays:u.country||"Pays non trouvé",region:u.state||u.region||u.county||"Région non trouvée",code_postal:u.postcode||"Code postal non trouvé",rue:u.road||u.street||"Rue non trouvée",code_pays:u.country_code?u.country_code.toUpperCase():"Code pays non trouvé"}}catch{return{village:"Erreur",adresse:"Erreur lors de la récupération",pays:"Erreur",region:"Erreur",code_postal:"Erreur",rue:"Erreur",code_pays:"Erreur"}}}const ce=({open:j=!0,setOpen:C,dataModify:l={},onCloseFormulaire:x=()=>{}})=>{const[u,b]=n.useState("Enregistrer"),[F,f]=n.useState(!1),[c,v]=n.useState({}),[I,E]=n.useState([]),[$,w]=n.useState(!1),{data:o,setData:d,errors:r}=O({client_id:0,date_installation:new Date().toISOString().split("T")[0],puissance_pompe:"",profondeur_forage:"",debit_nominal:"",numero_serie:"",code_installation:"",source_eau:"Puits",hmt:"",latitude:"",longitude:"",pays:"",ville:"",statuts:"installée"}),y=n.useCallback(t=>{if(!t||t.length===0)return"I0001";const p=t.reduce((s,S)=>{var R;const q=(R=S.code_installation)==null?void 0:R.match(/I(\d+)/);if(q){const A=parseInt(q[1],10);return A>s?A:s}return s},0)+1;return`I${String(p).padStart(4,"0")}`},[]),L=n.useCallback(async()=>{try{const[{clients:t},a]=await Promise.all([Y(),V()]),p=t.map(S=>({id:S.id,nom:`${S.nom} ${S.prenom}`})),s=y(a.data);E(p),l.id||d("code_installation",s)}catch(t){console.error("Error fetching clients and installations:",t)}},[l.id,d,y]),N=n.useCallback(t=>{C(!1),k(),x(t)},[C,x]),k=n.useCallback(()=>{d({client_id:0,date_installation:new Date().toISOString().split("T")[0],puissance_pompe:"",profondeur_forage:"",debit_nominal:"",numero_serie:"",code_installation:"I0001",source_eau:"Puits",hmt:"",latitude:"",longitude:"",pays:"",ville:"",statuts:"installée"}),f(!1),b("Enregistrer"),v({})},[d]),i=n.useCallback(t=>{v(a=>({...a,[t]:""}))},[]);n.useEffect(()=>{var t,a;L(),l.id?(d({client_id:l.client_id||0,date_installation:Z(l.date_installation)||new Date().toISOString().split("T")[0],puissance_pompe:l.puissance_pompe||"",profondeur_forage:l.profondeur_forage||"",debit_nominal:l.debit_nominal||"",numero_serie:l.numero_serie||"",code_installation:l.code_installation||"",source_eau:l.source_eau||"Puits",hmt:l.hmt||"",ville:((t=l.localisation)==null?void 0:t.ville)||"Kara",pays:((a=l.localisation)==null?void 0:a.pays)||"Togo",latitude:l.latitude||"",longitude:l.longitude||"",statuts:l.statuts||"installée"}),b("Modifier")):k()},[l,d,L,k]);const D=n.useCallback(async()=>{if(!o.latitude||!o.longitude){console.warn("Latitude and longitude are required for location lookup");return}w(!0);try{const t=await ue(o.latitude,o.longitude);d("ville",t.region||t.village||t.adresse||prev.ville),d("pays",t.pays)}catch(t){console.error("Error getting location:",t)}finally{w(!1)}},[o.latitude,o.longitude,d]),P=async()=>{var a,p;const t=u==="Enregistrer";if(!(t&&!z(o,v))){f(!0),b("Chargement...");try{let s;t?{message:s}=await K(o):{message:s}=await J(l.id,o),N(s)}catch(s){console.error("Error submitting installation:",s),(p=(a=s.response)==null?void 0:a.data)!=null&&p.errors?v(s.response.data.errors):v({general:"Une erreur est survenue lors de la soumission du formulaire."})}finally{f(!1),b(t?"Enregistrer":"Modifier")}}};n.useEffect(()=>{o.latitude&&o.longitude&&D()},[o.latitude,o.longitude,D]);const T=n.useCallback(t=>{d("client_id",t.id),i("client_id")},[d,i]),m=n.useCallback((t,a)=>{d(t,a),i(t)},[d,i]);return e.jsxs(U,{show:j,closeable:!1,onClose:N,maxWidth:"4xl",children:[e.jsx("div",{className:"text-2xl font-semibold text-center",children:l.id?"Modifier une Installation":"Ajouter une Installation"}),c.general&&e.jsx("div",{className:"p-3 mt-4 text-red-700 bg-red-100 border border-red-300 rounded",children:c.general}),e.jsxs("form",{className:"grid w-full grid-cols-1 gap-4 my-6 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx(_,{htmlFor:"client_id",value:"Nom client"}),e.jsx(X,{data:I,className:"block w-full mt-1",onSelect:T,defaultValue:o.client_id??0,onFocus:()=>i("client_id")}),e.jsx(g,{message:c.client_id||r.client_id,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"numero_serie",value:"Numéro de série de la pompe"}),e.jsx(h,{id:"numero_serie",name:"numero_serie",value:o.numero_serie,className:"block w-full mt-1",autoComplete:"numero_serie",onChange:t=>m("numero_serie",t.target.value),required:!0,onFocus:()=>i("numero_serie")}),e.jsx(g,{message:c.numero_serie||r.numero_serie,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"source_eau",value:"Source d'eau"}),e.jsxs(te,{id:"source_eau",name:"source_eau",value:o.source_eau,className:"block w-full mt-1",autoComplete:"source_eau",onChange:t=>m("source_eau",t.target.value),required:!0,children:[e.jsx("option",{value:"Puits",children:"Puits"}),e.jsx("option",{value:"Forage",children:"Forage"}),e.jsx("option",{value:"Etang",children:"Etang"}),e.jsx("option",{value:"Barrage",children:"Barrage"}),e.jsx("option",{value:"Rivière",children:"Rivière"})]}),e.jsx(g,{message:c.source_eau||r.source_eau,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"hmt",value:"HMT (m)"}),e.jsx(h,{id:"hmt",name:"hmt",value:o.hmt,className:"block w-full mt-1",autoComplete:"hmt",onChange:t=>m("hmt",t.target.value),required:!0,type:"number",onFocus:()=>i("hmt")}),e.jsx(g,{message:c.hmt||r.hmt,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"profondeur_forage",value:"Distance maximale pompe champ PV (m)"}),e.jsx(h,{id:"profondeur_forage",name:"profondeur_forage",value:o.profondeur_forage,className:"block w-full mt-1",autoComplete:"profondeur_forage",onChange:t=>m("profondeur_forage",t.target.value),required:!0,type:"number",onFocus:()=>i("profondeur_forage")}),e.jsx(g,{message:c.profondeur_forage||r.profondeur_forage,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"debit_nominal",value:"Débit nominal (m³/h)"}),e.jsx(h,{id:"debit_nominal",name:"debit_nominal",value:o.debit_nominal,className:"block w-full mt-1",autoComplete:"debit_nominal",onChange:t=>m("debit_nominal",t.target.value),required:!0,type:"number",onFocus:()=>i("debit_nominal")}),e.jsx(g,{message:c.debit_nominal||r.debit_nominal,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"puissance_pompe",value:"Puissance crête installé (W)"}),e.jsx(h,{id:"puissance_pompe",name:"puissance_pompe",value:o.puissance_pompe,className:"block w-full mt-1",autoComplete:"puissance_pompe",onChange:t=>m("puissance_pompe",t.target.value),required:!0,type:"number",onFocus:()=>i("puissance_pompe")}),e.jsx(g,{message:c.puissance_pompe||r.puissance_pompe,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"latitude",value:"Latitude"}),e.jsx(h,{id:"latitude",name:"latitude",value:o.latitude,className:"block w-full mt-1",autoComplete:"latitude",type:"number",step:"any",onChange:t=>m("latitude",t.target.value),onFocus:()=>i("latitude")}),e.jsx(g,{message:c.latitude||r.latitude,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"longitude",value:"Longitude"}),e.jsx(h,{id:"longitude",name:"longitude",value:o.longitude,className:"block w-full mt-1",autoComplete:"longitude",type:"number",step:"any",onChange:t=>m("longitude",t.target.value),onFocus:()=>i("longitude")}),e.jsx(g,{message:c.longitude||r.longitude,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"pays",value:"Pays"}),e.jsx(h,{id:"pays",name:"pays",value:o.pays,readOnly:!0,className:"block w-full mt-1",autoComplete:"pays",onChange:t=>m("pays",t.target.value),required:!0,onFocus:()=>i("pays")}),e.jsx(g,{message:c.pays||r.pays,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"ville",value:"Ville"}),e.jsx(h,{id:"ville",name:"ville",value:o.ville,readOnly:!0,className:"block w-full mt-1",autoComplete:"ville",onChange:t=>m("ville",t.target.value),required:!0,onFocus:()=>i("ville")}),e.jsx(g,{message:c.ville||r.ville,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"date_installation",value:"Date de l'installation"}),e.jsx(h,{id:"date_installation",name:"date_installation",value:o.date_installation,className:"block w-full mt-1",autoComplete:"date_installation",type:"date",onChange:t=>m("date_installation",t.target.value),required:!0,onFocus:()=>i("date_installation")}),e.jsx(g,{message:c.date_installation||r.date_installation,className:"mt-2"})]})]}),e.jsx("div",{className:"flex items-center justify-end px-1",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{type:"button",className:"px-4 py-2 text-red-500 rounded-md bg-red-400/10 hover:bg-red-400/20",onClick:()=>N(""),children:"Fermer"}),e.jsx("button",{type:"submit",className:`rounded-md py-2 px-4 disabled:cursor-not-allowed bg-blue-500 text-white hover:bg-blue-600 ${F&&"opacity-50"}`,disabled:F,onClick:P,children:u})]})})]})},$e=()=>{const[j,C]=n.useState(""),[l,x]=n.useState(!1),[u,b]=n.useState({}),[F,f]=n.useState(1),[c,v]=n.useState([]),[I,E]=n.useState([]),[$,w]=n.useState(!0),[o,d]=n.useState({open:!1,message:"",id:0}),[r,y]=n.useState({open:!1,message:"",type:"success"}),L=[{key:"code_installation",label:"Code",sortable:!0},{key:"nom",label:"Nom client",sortable:!0},{key:"numero_serie",label:"Numéro de série de la pompe",sortable:!0},{key:"puissance_pompe",label:"Puissance crête installé (W)"},{key:"profondeur_forage",label:"Distance maximale pompe champ PV (m)"},{key:"debit_nominal",label:"Débit nominal (m³/h)"},{key:"source_eau",label:"Source d'eau"},{key:"hmt",label:"HMT (m)"},{key:"date_installation",label:"Date de l'installation",sortable:!0},{key:"statuts",label:"Statuts",customRender:a=>e.jsx("span",{className:`px-2 py-1 rounded-full text-white flex text-nowrap cursor-pointer ${a==="installée"?"bg-green-500/50":a==="en cours"?"bg-blue-500/50":"bg-red-500/50"}`,children:a})},{key:"created_via",label:"Via",customRender:a=>e.jsx("span",{className:"text-xl font-medium text-gray-900 dark:text-white",children:a==="web"?e.jsx(re,{}):e.jsx(oe,{className:"text-blue-400 bg-white"})})}],N=[{label:e.jsx(le,{className:"text-lg"}),color:"text-blue-500",hoverColor:"text-blue-600",handler:a=>t(a)},{label:e.jsx(ne,{className:"text-base"}),color:"text-red-500",hoverColor:"text-red-600",handler:a=>T(a)}],k=()=>{x(!0)},i=async()=>{w(!0);const{data:a}=await V(),p=a.map(s=>({id:s.id,code_installation:s.code_installation,client_id:s.client_id,nom:s.client.nom+" "+s.client.prenom,puissance_pompe:s.puissance_pompe,profondeur_forage:s.profondeur_forage,debit_nominal:s.debit_nominal,numero_serie:s.numero_serie,source_eau:s.source_eau,hmt:s.hmt,date_installation:M(s.date_installation),statuts:s.statuts,latitude:s.localisation.latitude,longitude:s.localisation.longitude,created_via:s.created_via}));v(p),E(p),w(!1)};n.useEffect(()=>{i()},[]);const D=a=>{C(a),f(1);const p=c.filter(s=>s.nom.toLowerCase().includes(a.toLowerCase())||s.code_installation.toLowerCase().includes(a.toLowerCase())||s.numero_serie.toLowerCase().includes(a.toLowerCase())||s.source_eau.toLowerCase().includes(a.toLowerCase())||s.statuts.toLowerCase().includes(a.toLowerCase())||s.date_installation.toString().toLowerCase().includes(a.toLowerCase()));E(p)},P=a=>{i(),a&&y({...r,message:a,open:!0}),b({})},T=a=>{d({open:!0,message:`Êtes-vous sûr de vouloir supprimer l'installation numéro ${a.code_installation} du ${a.nom} le ${a.date_installation} ?`,id:a.id})},m=async()=>{const{message:a}=await Q(o.id);y({...r,message:a,open:!0}),d({...o,open:!1,id:0}),i(),f(1)},t=a=>{const p=a.date_installation?a.date_installation:"Invalid date";b({...a,date_installation:ee(p)}),x(!0)};return e.jsxs(se,{children:[e.jsx(H,{title:"Installations"}),e.jsx(G,{title:`Liste des Installations ( Total: ${c.length} )`,handleClick:k,onSearch:D,search:j}),e.jsx(ce,{open:l,setOpen:x,onCloseFormulaire:P,dataModify:u}),e.jsx(ae,{message:r.message,type:r.type,duration:3e3,position:"top-right",show:r.open,onClose:()=>y({...r,message:"",open:!1})}),e.jsx(W,{open:o.open,message:o.message,btnAcceptName:"Supprimer",title:"Suppression",btnAcceptColor:"bg-red-500 text-white",close:()=>d({...o,open:!1}),accept:m}),$?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"w-12 h-12 border-t-2 border-b-2 border-blue-500 rounded-full animate-spin"})}):e.jsx("div",{children:I.length>0?e.jsx(B,{headers:L,rows:I,itemsPerPage:6,actions:N,className:"mt-4",currentPage:F,onPageChange:f,masqueColumns:["client_id","latitude","longitude"]}):e.jsx(ie,{nom:"installation",search:j})})]})};export{$e as default};
