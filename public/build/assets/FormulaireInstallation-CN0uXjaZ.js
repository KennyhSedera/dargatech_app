import{r as i,v as W,j as t}from"./app-BJfPsfag.js";import{M as H}from"./Modal-C4qayzp5.js";import{I as _,T as x}from"./TextInput-DffsfSTR.js";import{I as g}from"./InputLabel-CSzd5EZb.js";import{g as K,c as G,u as J}from"./installationService-nJyEzGFk.js";import{I as Q}from"./InputAutocomplete -BLyVlZjz.js";import{b as X}from"./clientService-BE-d0xJq.js";import{z as Y}from"./constant-cHJbaWBm.js";import{S as Z}from"./SelectInput-BV4wJT1W.js";import{I as D}from"./InputImage-C8SpDbGF.js";async function M(N,f){try{const b=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${N}&lon=${f}&zoom=18&addressdetails=1`)).json(),l=b.address;return{village:l.village||l.town||l.city||l.hamlet||"Non trouvé",adresse:b.display_name||"Adresse non trouvée",pays:l.country||"Pays non trouvé",region:l.state||l.region||l.county||"Région non trouvée",code_postal:l.postcode||"Code postal non trouvé",rue:l.road||l.street||"Rue non trouvée",code_pays:l.country_code?l.country_code.toUpperCase():"Code pays non trouvé"}}catch{return{village:"Erreur",adresse:"Erreur lors de la récupération",pays:"Erreur",region:"Erreur",code_postal:"Erreur",rue:"Erreur",code_pays:"Erreur"}}}const de=({open:N=!0,setOpen:f,dataModify:o={},onCloseFormulaire:b=()=>{},token_data:l})=>{const[E,F]=i.useState("Enregistrer"),[k,y]=i.useState(!1),[u,j]=i.useState({}),[P,$]=i.useState([]),[R,L]=i.useState(!1),V=i.useRef(null),{data:a,setData:c,errors:m}=W({client_id:"",date_installation:new Date().toISOString().split("T")[0],puissance_pompe:"",profondeur_forage:"",debit_nominal:"",numero_serie:"",code_installation:"",source_eau:"Puits",hmt:"",latitude:"",longitude:"",pays:"",ville:"",statuts:"installée",photos_installation:[]}),S=i.useCallback(e=>{if(!e||e.length===0)return"I0001";const d=e.reduce((p,s)=>{var C;const v=(C=s.code_installation)==null?void 0:C.match(/I(\d+)/);if(v){const T=parseInt(v[1],10);return T>p?T:p}return p},0)+1;return`I${String(d).padStart(4,"0")}`},[]),A=i.useCallback(async()=>{try{const[{clients:e},n]=await Promise.all([X(),K()]),d=e.filter(s=>s.is_payed!==!1).map(s=>({id:s.id,nom:`${s.nom} ${s.prenom}`})),p=S(n.data);$(d),o.id||c("code_installation",p)}catch(e){console.error("Error fetching clients and installations:",e)}},[o.id,c,S]),w=i.useCallback(e=>{f(!1),I(),b(e)},[f,b]),I=i.useCallback(()=>{c({client_id:"",date_installation:new Date().toISOString().split("T")[0],puissance_pompe:"",profondeur_forage:"",debit_nominal:"",numero_serie:"",code_installation:"I0001",source_eau:"Puits",hmt:"",latitude:"",longitude:"",pays:"",ville:"",statuts:"installée",photos_installation:[]}),y(!1),F("Enregistrer"),j({})},[c]),r=i.useCallback(e=>{j(n=>({...n,[e]:""}))},[]);i.useEffect(()=>{var e,n;A(),o.id?(c({client_id:o.client_id||"",date_installation:Y(o.date_installation)||new Date().toISOString().split("T")[0],puissance_pompe:o.puissance_pompe||"",profondeur_forage:o.profondeur_forage||"",debit_nominal:o.debit_nominal||"",numero_serie:o.numero_serie||"",code_installation:o.code_installation||"",source_eau:o.source_eau||"Puits",hmt:o.hmt||"",ville:((e=o.localisation)==null?void 0:e.ville)||"Kara",pays:((n=o.localisation)==null?void 0:n.pays)||"Togo",latitude:o.latitude||"",longitude:o.longitude||"",statuts:o.statuts||"installée",photos_installation:o.photos_installation||[],created_via:o.created_via||"web"}),F("Modifier")):I()},[o,c,I]);const q=i.useCallback(async(e,n)=>{if(!e||!n){console.warn("Latitude and longitude are required for location lookup");return}L(!0);try{const d=await M(e,n);c(p=>({...p,ville:d.region||d.village||d.adresse||p.ville,pays:d.pays||p.pays}))}catch(d){console.error("Error getting location:",d)}finally{L(!1)}},[c]),O=e=>{const n={};return(!e.client_id||e.client_id===""||e.client_id===0)&&(n.client_id="Veuillez sélectionner un client"),["puissance_pompe","profondeur_forage","debit_nominal","hmt"].forEach(s=>{!e[s]||e[s]===""?n[s]=`Le champ ${s} est requis`:(isNaN(e[s])||parseFloat(e[s])<=0)&&(n[s]=`Le champ ${s} doit être un nombre positif`)}),["numero_serie","code_installation"].forEach(s=>{(!e[s]||e[s].trim()==="")&&(n[s]=`Le champ ${s} est requis`)}),!e.latitude||e.latitude===""?n.latitude="La latitude est requise":(isNaN(e.latitude)||parseFloat(e.latitude)<-90||parseFloat(e.latitude)>90)&&(n.latitude="La latitude doit être comprise entre -90 et 90"),!e.longitude||e.longitude===""?n.longitude="La longitude est requise":(isNaN(e.longitude)||parseFloat(e.longitude)<-180||parseFloat(e.longitude)>180)&&(n.longitude="La longitude doit être comprise entre -180 et 180"),e.date_installation?new Date(e.date_installation)>new Date&&(n.date_installation="La date d'installation ne peut pas être dans le futur"):n.date_installation="La date d'installation est requise",{isValid:Object.keys(n).length===0,errors:n}},z=async()=>{var d,p;const e=E==="Enregistrer",n=O(a);if(!n.isValid){j(n.errors);return}y(!0),F("Chargement...");try{let s;Array.isArray(a.photos_installation)&&a.photos_installation.length>0?(s=new FormData,s.append("client_id",parseInt(a.client_id)),s.append("date_installation",a.date_installation),s.append("puissance_pompe",parseFloat(a.puissance_pompe)),s.append("profondeur_forage",parseFloat(a.profondeur_forage)),s.append("debit_nominal",parseFloat(a.debit_nominal)),s.append("numero_serie",a.numero_serie),s.append("code_installation",a.code_installation),s.append("source_eau",a.source_eau),s.append("hmt",parseFloat(a.hmt)),s.append("latitude",parseFloat(a.latitude)),s.append("longitude",parseFloat(a.longitude)),s.append("pays",a.pays||""),s.append("ville",a.ville||""),s.append("statuts",a.statuts),s.append("created_via",l?"telegram_bot":"web"),a.photos_installation.forEach(C=>{s.append("photos_installation[]",C)})):s={client_id:parseInt(a.client_id),date_installation:a.date_installation,puissance_pompe:parseFloat(a.puissance_pompe),profondeur_forage:parseFloat(a.profondeur_forage),debit_nominal:parseFloat(a.debit_nominal),numero_serie:a.numero_serie,code_installation:a.code_installation,source_eau:a.source_eau,hmt:parseFloat(a.hmt),latitude:parseFloat(a.latitude),longitude:parseFloat(a.longitude),pays:a.pays||"",ville:a.ville||"",statuts:a.statuts,created_via:l?"telegram_bot":"web"};let v;e?{message:v}=await G(s):{message:v}=await J(o.id,s),w(v)}catch(s){console.error("Error submitting installation:",s),(p=(d=s.response)==null?void 0:d.data)!=null&&p.errors?j(s.response.data.errors):j({general:"Une erreur est survenue lors de la soumission."})}finally{y(!1),F(e?"Enregistrer":"Modifier")}};i.useEffect(()=>{const e=setTimeout(()=>{a.latitude&&a.longitude&&q(a.latitude,a.longitude)},500);return()=>clearTimeout(e)},[a.latitude,a.longitude,q]);const B=i.useCallback(e=>{c("client_id",e.id),r("client_id")},[c,r]),h=i.useCallback((e,n)=>{c(e,n),r(e)},[c,r]),U=e=>{c(n=>({...n,photos_installation:e})),r("photos_installation")};return t.jsxs(H,{show:N,closeable:!1,onClose:w,maxWidth:"4xl",children:[t.jsx("div",{className:"text-2xl font-semibold text-center",children:o.id?"Modifier une Installation":"Ajouter une Installation"}),u.general&&t.jsx("div",{className:"p-3 mt-4 text-red-700 bg-red-100 border border-red-300 rounded",children:u.general}),t.jsxs("form",{className:"grid w-full grid-cols-1 gap-4 my-6 sm:grid-cols-3",children:[t.jsxs("div",{children:[t.jsx(g,{htmlFor:"client_id",value:"Nom client *"}),t.jsx(Q,{data:P,className:"block w-full mt-1",onSelect:B,defaultValue:a.client_id??"",onFocus:()=>r("client_id")}),t.jsx(_,{message:u.client_id||m.client_id,className:"mt-2"})]}),t.jsxs("div",{children:[t.jsx(g,{htmlFor:"numero_serie",value:"Numéro de série de la pompe *"}),t.jsx(x,{id:"numero_serie",name:"numero_serie",value:a.numero_serie,className:"block w-full mt-1",autoComplete:"numero_serie",onChange:e=>h("numero_serie",e.target.value),required:!0,onFocus:()=>r("numero_serie")}),t.jsx(_,{message:u.numero_serie||m.numero_serie,className:"mt-2"})]}),t.jsxs("div",{children:[t.jsx(g,{htmlFor:"source_eau",value:"Source d'eau *"}),t.jsxs(Z,{id:"source_eau",name:"source_eau",value:a.source_eau,className:"block w-full mt-1",autoComplete:"source_eau",onChange:e=>h("source_eau",e.target.value),required:!0,children:[t.jsx("option",{value:"Puits",children:"Puits"}),t.jsx("option",{value:"Forage",children:"Forage"}),t.jsx("option",{value:"Etang",children:"Etang"}),t.jsx("option",{value:"Barrage",children:"Barrage"}),t.jsx("option",{value:"Rivière",children:"Rivière"})]}),t.jsx(_,{message:u.source_eau||m.source_eau,className:"mt-2"})]}),t.jsxs("div",{children:[t.jsx(g,{htmlFor:"hmt",value:"HMT (m) *"}),t.jsx(x,{id:"hmt",name:"hmt",value:a.hmt,className:"block w-full mt-1",autoComplete:"hmt",onChange:e=>h("hmt",e.target.value),required:!0,type:"number",min:"0",step:"0.01",onFocus:()=>r("hmt")}),t.jsx(_,{message:u.hmt||m.hmt,className:"mt-2"})]}),t.jsxs("div",{children:[t.jsx(g,{htmlFor:"profondeur_forage",value:"Distance maximale pompe champ PV (m) *"}),t.jsx(x,{id:"profondeur_forage",name:"profondeur_forage",value:a.profondeur_forage,className:"block w-full mt-1",autoComplete:"profondeur_forage",onChange:e=>h("profondeur_forage",e.target.value),required:!0,type:"number",min:"0",step:"0.01",onFocus:()=>r("profondeur_forage")}),t.jsx(_,{message:u.profondeur_forage||m.profondeur_forage,className:"mt-2"})]}),t.jsxs("div",{children:[t.jsx(g,{htmlFor:"debit_nominal",value:"Débit nominal (m³/h) *"}),t.jsx(x,{id:"debit_nominal",name:"debit_nominal",value:a.debit_nominal,className:"block w-full mt-1",autoComplete:"debit_nominal",onChange:e=>h("debit_nominal",e.target.value),required:!0,type:"number",min:"0",step:"0.01",onFocus:()=>r("debit_nominal")}),t.jsx(_,{message:u.debit_nominal||m.debit_nominal,className:"mt-2"})]}),t.jsxs("div",{children:[t.jsx(g,{htmlFor:"puissance_pompe",value:"Puissance crête installé (W) *"}),t.jsx(x,{id:"puissance_pompe",name:"puissance_pompe",value:a.puissance_pompe,className:"block w-full mt-1",autoComplete:"puissance_pompe",onChange:e=>h("puissance_pompe",e.target.value),required:!0,type:"number",min:"0",step:"0.01",onFocus:()=>r("puissance_pompe")}),t.jsx(_,{message:u.puissance_pompe||m.puissance_pompe,className:"mt-2"})]}),t.jsxs("div",{children:[t.jsx(g,{htmlFor:"latitude",value:"Latitude *"}),t.jsx(x,{id:"latitude",name:"latitude",value:a.latitude,className:"block w-full mt-1",autoComplete:"latitude",type:"number",step:"any",min:"-90",max:"90",onChange:e=>h("latitude",e.target.value),onFocus:()=>r("latitude"),required:!0}),t.jsx(_,{message:u.latitude||m.latitude,className:"mt-2"})]}),t.jsxs("div",{children:[t.jsx(g,{htmlFor:"longitude",value:"Longitude *"}),t.jsx(x,{id:"longitude",name:"longitude",value:a.longitude,className:"block w-full mt-1",autoComplete:"longitude",type:"number",step:"any",min:"-180",max:"180",onChange:e=>h("longitude",e.target.value),onFocus:()=>r("longitude"),required:!0}),t.jsx(_,{message:u.longitude||m.longitude,className:"mt-2"})]}),t.jsxs("div",{children:[t.jsx(g,{htmlFor:"pays",value:"Localisation"}),t.jsx(x,{id:"pays",name:"pays",value:a.pays+", "+a.ville,readOnly:!0,className:"block w-full mt-1 bg-gray-50",autoComplete:"pays"}),R&&t.jsx("p",{className:"mt-1 text-sm text-blue-500",children:"Recherche de la localisation..."}),t.jsx(_,{message:u.pays||m.pays,className:"mt-2"})]}),t.jsxs("div",{children:[t.jsx(g,{htmlFor:"photos_installation",value:"Photo de l'installation"}),t.jsx(D,{ref:V,selectedFiles:a.photos_installation,onLoadFile:U,onFocus:()=>r("photos_installation"),multiple:!0,placeholder:"Sélectionner une photo"}),t.jsx(_,{message:u.photos_installation||m.photos_installation,className:"mt-2"})]}),t.jsxs("div",{children:[t.jsx(g,{htmlFor:"date_installation",value:"Date de l'installation *"}),t.jsx(x,{id:"date_installation",name:"date_installation",value:a.date_installation,className:"block w-full mt-1",autoComplete:"date_installation",type:"date",max:new Date().toISOString().split("T")[0],onChange:e=>h("date_installation",e.target.value),required:!0,onFocus:()=>r("date_installation")}),t.jsx(_,{message:u.date_installation||m.date_installation,className:"mt-2"})]})]}),t.jsx("div",{className:"flex items-center justify-end px-1",children:t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsx("button",{type:"button",className:"px-4 py-2 text-red-500 rounded-md bg-red-400/10 hover:bg-red-400/20",onClick:()=>w(""),children:"Fermer"}),t.jsx("button",{type:"submit",className:`rounded-md py-2 px-4 disabled:cursor-not-allowed bg-blue-500 text-white hover:bg-blue-600 ${k&&"opacity-50"}`,disabled:k,onClick:z,children:E})]})})]})};export{de as F};
