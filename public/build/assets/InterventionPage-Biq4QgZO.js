import{r as o,v as O,j as e,q as Y,$ as Z,m as $}from"./app-CKIQC7bl.js";import{C as ee}from"./ConfirmDialog-DpPfg_rg.js";import{D as te}from"./DataTable-gPVHnAYW.js";import{E as ne}from"./EmptyState-BuVt_WbL.js";import{H as ie}from"./HeaderPage-Cu_PBayX.js";import{M as V}from"./Modal-OJ7ZqoQe.js";import{I as b,T as B}from"./TextInput-CrJOgruW.js";import{I as f}from"./InputLabel-CLXF8NDZ.js";import{g as oe}from"./installationService-DJ9FzzDK.js";import{I as re}from"./InputAutocomplete -C9q5CEsw.js";import{r as se,f as ae,q as le}from"./constant-Ccl-ng2K.js";import{c as ce,u as me,a as de,g as pe,d as ue}from"./maintenanceService-Chv30WTs.js";import{S as _e}from"./SelectInput-D3RubUYM.js";import{a as ve}from"./validateForm-f9K0gDaZ.js";import"./api-DgjbNlyT.js";import{T as k}from"./TextArea-uAW7LeS_.js";import{I as fe}from"./InputImage-DcRnvjAy.js";import{S as z}from"./Snackbar-BgpWpSLL.js";import{A as be}from"./AuthenticatedLayout-BmgAKyoc.js";import{G as xe}from"./index-y2Q3NTKV.js";import{T as ge}from"./index-D8MTw20h.js";import"./index-C37N_ndF.js";import"./iconBase-BrNMzGLU.js";import"./transition-De7C3uv9.js";import"./createLucideIcon-CKqiLiGq.js";import"./useTheme-CqPKuz4y.js";const he=({open:D=!0,setOpen:E,dataModify:r={},onCloseFormulaire:L=()=>{},idTechnicien:x})=>{const[h,i]=o.useState("Enregistrer"),[s,p]=o.useState(!1),[u,g]=o.useState({}),[a,_]=o.useState([]),{data:c,setData:m,errors:N,reset:j}=O({installation_id:0,date_intervention:new Date().toISOString().split("T")[0],type_intervention:"préventive",description_probleme:"",solutions_apportees:"",duree_intervention:"",technicien:x}),I=async()=>{const[{data:t}]=await Promise.all([oe()]),C=t.filter(d=>d.statuts!=="en panne").map(d=>({id:d.id,nom:d.code_installation}));_(C)},y=t=>{E(!1),F(),L(t)},F=()=>{j(),p(!1),i("Enregistrer"),g({})};o.useEffect(()=>{I(),r.id?(m({installation_id:r.installation_id||0,date_intervention:se(r.date_intervention)||new Date().toISOString().split("T")[0],type_intervention:r.type_intervention||"",description_probleme:r.description_probleme||"",solutions_apportees:r.solutions_apportees||"",duree_intervention:r.duree_intervention||"",technicien:r.technicien_id||0}),i("Modifier")):F()},[r,m]),o.useEffect(()=>{x&&m("technicien",x)},[x,m]);const w=async()=>{if(ve(c,g)){p(!0),i("Chargement...");try{let t;h==="Enregistrer"?{message:t}=await ce(c):{message:t}=await me(r.id,c),y(t)}catch(t){console.error("Error submitting payment:",t)}finally{p(!1),i("Enregistrer")}}},S=t=>{m({...c,installation_id:t.id,description_probleme:t.message})};return e.jsxs(V,{show:D,closeable:!1,onClose:y,maxWidth:"4xl",children:[e.jsx("div",{className:"text-2xl font-semibold text-center",children:r.nom?"Modifier une Intervention":"Ajouter une Intervention"}),e.jsxs("form",{className:"grid w-full grid-cols-1 gap-4 px-6 my-6",children:[e.jsxs("div",{children:[e.jsx(f,{htmlFor:"installation_id",value:"Code d'instalation"}),e.jsx(re,{data:a,className:"block w-full mt-1",onSelect:S,defaultValue:c.installation_id,readOnly:r.id,onFocus:()=>g({...u,installation_id:""})}),e.jsx(b,{message:u.installation_id||N.installation_id,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"type_intervention",value:"Type d'intervention"}),e.jsxs(_e,{id:"type_intervention",type:"type_intervention",name:"type_intervention",value:c.type_intervention,className:"block w-full mt-1",autoComplete:"type_intervention",onChange:t=>m("type_intervention",t.target.value),required:!0,children:[e.jsx("option",{value:"préventive",children:"Préventive"}),e.jsx("option",{value:"curative",children:"Curative"})]}),e.jsx(b,{message:N.email,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"description_probleme",value:"Description du problème"}),e.jsx(k,{id:"description_probleme",name:"description_probleme",value:c.description_probleme,className:"block w-full mt-1",autoComplete:"description_probleme",onChange:t=>m("description_probleme",t.target.value),required:!0,rows:4,onFocus:()=>g({...u,description_probleme:""})}),e.jsx(b,{message:u.description_probleme||N.description_probleme,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"date_intervention",value:"Date d'intervention"}),e.jsx(B,{id:"date_intervention",name:"date_intervention",value:c.date_intervention,className:"block w-full mt-1",autoComplete:"date_intervention",type:"date",onChange:t=>m("date_intervention",t.target.value),required:!0,onFocus:()=>g({...u,date_intervention:""})}),e.jsx(b,{message:u.date_intervention||N.date_intervention,className:"mt-2"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-4 px-6",children:[e.jsx("button",{type:"button",className:"px-4 py-1 text-red-500 rounded-md bg-red-400/10",onClick:()=>y(""),children:"Fermer"}),e.jsx("button",{type:"submit",className:`rounded-md py-1 px-4 disabled:cursor-not-allowed bg-blue-500 text-white ${s&&"opacity-25"}`,disabled:s,onClick:w,children:h})]})]})},je=({open:D=!0,setOpen:E,dataModify:r={},onCloseFormulaire:L=()=>{},idTechnicien:x})=>{const h=new Date().toISOString().split("T")[0],{data:i,setData:s,errors:p}=O({clientId:0,technicienId:x,maintenanceId:0,description_probleme:"",photo_probleme:[],verifications_preliminaires:"",resultat_diagnostic:"",actions_correctives:"",verification_fonctionnement:"",recommandations:"",date_intervention:h}),[u,g]=o.useState(!1),[a,_]=o.useState({}),[c,m]=o.useState({show:!1,message:"",type:"info"});o.useEffect(()=>{r&&(s("maintenanceId",r.id),s("clientId",r.idclient),s("description_probleme",r.description_probleme))},[r]);const N=o.useRef(null),[j,I]=o.useState({}),y=t=>{E(!1),s({clientId:0,technicienId:x||1,maintenanceId:0,description_probleme:"",photo_probleme:[],verifications_preliminaires:"",resultat_diagnostic:"",actions_correctives:"",verification_fonctionnement:"",recommandations:"",date_intervention:h}),L(t)},F=t=>{s("photo_probleme",t),j.photo_probleme&&I({...j,photo_probleme:""})},w=()=>{const t={};return i.description_probleme.trim()||(t.description_probleme="Le problème rapporté est obligatoire"),i.verifications_preliminaires.trim()||(t.verifications_preliminaires="Les vérifications préliminaires sont obligatoires"),i.resultat_diagnostic.trim()||(t.resultat_diagnostic="Le résultat du diagnostic est obligatoire"),i.actions_correctives.trim()||(t.actions_correctives="Les actions correctives sont obligatoires"),i.verification_fonctionnement.trim()||(t.verification_fonctionnement="La vérification du fonctionnement est obligatoire"),i.date_intervention||(t.date_intervention="La date d'intervention est obligatoire"),_(t),Object.keys(t).length===0},S=async()=>{if(w()){i.technicienId=x;try{if(g(!0),i.photo_probleme&&Array.isArray(i.photo_probleme)){for(const d of i.photo_probleme)if(d.size>5*1024*1024){m({show:!0,message:`Le fichier ${d.name} est trop volumineux (max 5MB)`,type:"error"});return}}const t=new FormData;t.append("clientId",i.clientId),t.append("technicienId",i.technicienId),t.append("maintenanceId",i.maintenanceId),t.append("description_probleme",i.description_probleme),i.photo_probleme&&Array.isArray(i.photo_probleme)&&i.photo_probleme.length>0&&i.photo_probleme.forEach((d,T)=>{t.append(`photo_probleme[${T}]`,d)}),t.append("verifications_preliminaires",i.verifications_preliminaires),t.append("resultat_diagnostic",i.resultat_diagnostic),t.append("actions_correctives",i.actions_correctives),t.append("verification_fonctionnement",i.verification_fonctionnement),t.append("recommandations",i.recommandations||""),t.append("date_intervention",i.date_intervention);const C=await de(t);y(C.message)}catch(t){console.error("Erreur lors de la création du rapport:",t),m({show:!0,message:"Une erreur est survenue lors de la création du rapport",type:"error"})}finally{g(!1)}}};return e.jsxs(V,{show:D,closeable:!1,onClose:y,maxWidth:"xl",children:[e.jsx("div",{className:"text-2xl font-semibold text-center",children:"Formulaire rapport maintenance"}),e.jsxs("form",{className:"grid w-full grid-cols-1 gap-4 my-6 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(f,{htmlFor:"description_probleme",value:"Problème rapporté *"}),e.jsx(k,{id:"description_probleme",name:"description_probleme",value:i.description_probleme,className:"block w-full mt-1",autoComplete:"off",onChange:t=>s("description_probleme",t.target.value),required:!0,rows:3,readOnly:!0,onFocus:()=>_({...a,description_probleme:""})}),e.jsx(b,{message:a.description_probleme||j.description_probleme||p.description_probleme,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"verifications_preliminaires",value:"Vérifications préliminaires *"}),e.jsx(k,{id:"verifications_preliminaires",name:"verifications_preliminaires",value:i.verifications_preliminaires,className:"block w-full mt-1",autoComplete:"off",onChange:t=>s("verifications_preliminaires",t.target.value),required:!0,rows:3,onFocus:()=>_({...a,verifications_preliminaires:""})}),e.jsx(b,{message:a.verifications_preliminaires||p.verifications_preliminaires,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"resultat_diagnostic",value:"Résultat du diagnostic *"}),e.jsx(k,{id:"resultat_diagnostic",name:"resultat_diagnostic",value:i.resultat_diagnostic,className:"block w-full mt-1",autoComplete:"off",onChange:t=>s("resultat_diagnostic",t.target.value),required:!0,rows:3,onFocus:()=>_({...a,resultat_diagnostic:""})}),e.jsx(b,{message:a.resultat_diagnostic||p.resultat_diagnostic,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"actions_correctives",value:"Actions correctives *"}),e.jsx(k,{id:"actions_correctives",name:"actions_correctives",value:i.actions_correctives,className:"block w-full mt-1",autoComplete:"off",onChange:t=>s("actions_correctives",t.target.value),required:!0,rows:3,onFocus:()=>_({...a,actions_correctives:""})}),e.jsx(b,{message:a.actions_correctives||p.actions_correctives,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"verification_fonctionnement",value:"Vérification du fonctionnement *"}),e.jsx(k,{id:"verification_fonctionnement",name:"verification_fonctionnement",value:i.verification_fonctionnement,className:"block w-full mt-1",autoComplete:"off",onChange:t=>s("verification_fonctionnement",t.target.value),required:!0,rows:3,onFocus:()=>_({...a,verification_fonctionnement:""})}),e.jsx(b,{message:a.verification_fonctionnement||p.verification_fonctionnement,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"recommandations",value:"Recommandations au Client (optionnel)"}),e.jsx(k,{id:"recommandations",name:"recommandations",value:i.recommandations,className:"block w-full mt-1",autoComplete:"off",onChange:t=>s("recommandations",t.target.value),rows:3,onFocus:()=>_({...a,recommandations:""})}),e.jsx(b,{message:p.recommandations,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"photo_probleme",value:"Photo du problème (optionnel)"}),e.jsx(fe,{ref:N,selectedFiles:i.photo_probleme,onLoadFile:F,onFocus:()=>I({...j,photo_probleme:""})})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"date_intervention",value:"Date de l'intervention *"}),e.jsx(B,{id:"date_intervention",name:"date_intervention",value:i.date_intervention,className:"block w-full mt-1",autoComplete:"off",onChange:t=>s("date_intervention",t.target.value),type:"date",required:!0,onFocus:()=>_({...a,date_intervention:""})}),e.jsx(b,{message:a.date_intervention||p.date_intervention,className:"mt-2"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-4 px-1",children:[e.jsx("button",{type:"button",className:"px-4 py-1 text-red-500 rounded-md bg-red-400/10",onClick:()=>y(""),children:"Fermer"}),e.jsx("button",{type:"submit",className:`rounded-md py-1 px-4 disabled:cursor-not-allowed bg-blue-500 text-white ${u&&"opacity-25"}`,disabled:u,onClick:S,children:u?"Enregistrement...":"Enregistrer"})]}),e.jsx(z,{show:c.show,message:c.message,type:c.type,onClose:()=>m({...c,show:!1})})]})},Je=()=>{const[D,E]=o.useState(""),[r,L]=o.useState(0),[x,h]=o.useState(!1),[i,s]=o.useState(!1),[p,u]=o.useState({}),[g,a]=o.useState({}),[_,c]=o.useState(1),[m,N]=o.useState([]),[j,I]=o.useState([]),[y,F]=o.useState(!0),[w,S]=o.useState({open:!1,message:"",id:0}),[t,C]=o.useState({open:!1,message:"",type:"success"}),d=Y().props.auth.user,T=[{key:"id",label:"ID",sortable:!0},{key:"code_installation",label:"Installation",sortable:!0},{key:"nom",label:"Client",sortable:!0},{key:"type_intervention",label:"Type"},{key:"description_probleme",label:"Problème",customRender:n=>e.jsxs("div",{className:"relative max-w-md group",children:[e.jsx("span",{className:"line-clamp-2",children:n}),e.jsx("div",{className:"absolute bottom-0 left-0 z-50 hidden max-w-md p-2 mt-2 text-sm text-gray-800 bg-white border border-gray-300 rounded shadow-md group-hover:block",children:n})]})},{key:"date_intervention",label:"Date d'intervenir",sortable:!0},{key:"status_intervention",label:"Statuts",customRender:n=>e.jsx("span",{className:`px-2 py-1 rounded-full text-white flex text-nowrap ${n==="terminée"?"bg-green-500/50":n==="en attente"?"bg-blue-500/50":"bg-red-500/50"}`,children:n})},{key:"status_intervention",label:"Rapport",sortable:!0,customRender:(n,v)=>{var l,A,q;return e.jsx("span",{onClick:()=>{var P;return n==="terminée"?$.visit("/rapport",{data:{intervention_id:v.id}}):((P=d.user_role)==null?void 0:P.name)==="partenaire"?null:M(v)},className:`px-2 py-1 rounded-full flex text-nowrap ${((l=d.user_role)==null?void 0:l.name)==="partenaire"&&n!=="terminée"?"cursor-default":"cursor-pointer"} ${n==="terminée"?"text-green-500":((A=d.user_role)==null?void 0:A.name)==="partenaire"?"text-gray-300":"text-blue-500"}`,children:n==="terminée"?"Consulter":((q=d.user_role)==null?void 0:q.name)==="partenaire"?"En attente":"Ajouter"})}}],G=[{label:e.jsx(ge,{className:"text-lg"}),color:"text-blue-500",hoverColor:"text-blue-600",handler:n=>X(n)},{label:e.jsx(xe,{className:"text-base"}),color:"text-red-500",hoverColor:"text-red-600",handler:n=>K(n)}],H=()=>{h(!0)},M=n=>{var v;((v=d.user_role)==null?void 0:v.name)==="partenaire"?$.visit("/rapport",{data:{intervention_id:n.id}}):(s(!0),a(n))},R=async()=>{F(!0);const{data:n}=await pe(),v=n.map(l=>({id:l.id,installation_id:l.installation_id,code_installation:l.installation.code_installation,nom:l.installation.client.nom+" "+l.installation.client.prenom,idclient:l.installation.client.id,type_intervention:l.type_intervention,description_probleme:l.description_probleme,status_intervention:l.status_intervention,date_intervention:ae(l.date_intervention)}));N(v),I(v),F(!1)};o.useEffect(()=>{R()},[]);const W=n=>{E(n),c(1);const v=m.filter(l=>l.nom.toLowerCase().includes(n.toLowerCase())||l.type_intervention.toLowerCase().includes(n.toLowerCase())||l.description_probleme.toLowerCase().includes(n.toLowerCase())||l.date_intervention.toString().toLowerCase().includes(n.toLowerCase()));I(v)},U=n=>{R(),n&&C({...t,message:n,open:!0}),u({})},J=n=>{R(),n&&C({...t,message:n,open:!0}),a({})},K=n=>{S({open:!0,message:`Êtes-vous sûr de vouloir supprimer l'intervention du ${n.nom} le ${n.date_intervention} ?`,id:n.id})},Q=async()=>{const{message:n}=await ue(w.id);C({...t,message:n,open:!0}),S({...w,open:!1,id:0}),R(),c(1)},X=n=>{const v=n.date_intervention?n.date_intervention:"Invalid date";u({...n,date_intervention:le(v)}),h(!0)};return e.jsxs(be,{setId:L,children:[e.jsx(Z,{title:"Maintenance"}),e.jsx(ie,{search:D,onSearch:W,title:`Liste des interventions ( Total: ${m.length} )`,handleClick:H}),e.jsx(z,{message:t.message,type:t.type,duration:3e3,position:"top-right",show:t.open,onClose:()=>C({...t,message:"",open:!1})}),e.jsx(ee,{open:w.open,message:w.message,btnAcceptName:"Supprimer",title:"Suppression",btnAcceptColor:"bg-red-500 text-white",close:()=>S({...w,open:!1}),accept:Q}),e.jsx(he,{open:x,setOpen:h,dataModify:p,onCloseFormulaire:U,idTechnicien:r}),e.jsx(je,{open:i,setOpen:s,dataModify:g,onCloseFormulaire:J,idTechnicien:r}),y?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"w-12 h-12 border-t-2 border-b-2 border-blue-500 rounded-full animate-spin"})}):e.jsx("div",{children:j.length>0?e.jsx(te,{headers:T,rows:j,itemsPerPage:6,actions:G,className:"mt-4",currentPage:_,onPageChange:c,masqueColumns:["client_id"]}):e.jsx(ne,{nom:"intervention",search:D})})]})};export{Je as default};
