import{q as V,v as $,r as d,j as e}from"./app-BNenjPtp.js";import{I as r}from"./InputLabel-dhwV7XHG.js";import{I as m,T as N}from"./TextInput-85TkMtt6.js";import{T as f}from"./TextArea-BIuH1maL.js";import{M}from"./Modal-Db5Z9qxK.js";import{I as C}from"./InputImage-D5Rx6LLG.js";import{g as O,a as z,b as B}from"./maintenanceService-D30-cEns.js";import{S as U}from"./Snackbar-BJpSLYhn.js";import{I as G}from"./InputAutocomplete -B6_u2VuA.js";const te=({open:E=!0,setOpen:S,dataModify:_={},onCloseFormulaire:k=()=>{},token_data:p})=>{const F=new Date().toISOString().split("T")[0],h=V().props.auth.user.id,{data:i,setData:o,errors:a}=$({clientId:0,userId:h,maintenanceId:0,description_probleme:"",photo_probleme:[],verifications_preliminaires:"",resultat_diagnostic:"",actions_correctives:"",verification_fonctionnement:"",recommandations:"",date_intervention:F}),[g,w]=d.useState(!1),[n,s]=d.useState({}),[v,x]=d.useState({show:!1,message:"",type:"info"}),[L,q]=d.useState([]),A=async()=>{const[{data:t}]=await Promise.all([O()]),l=t.filter(c=>c.status_intervention!=="terminée").map(c=>({id:c.installation.id,nom:c.installation.code_installation}));q(l)};d.useEffect(()=>{A()},[]),d.useEffect(()=>{_&&(o("maintenanceId",_.id),o("clientId",_.idclient),o("description_probleme",_.description_probleme))},[_]);const I=d.useRef(null),[u,b]=d.useState({}),j=t=>{S(!1),o({clientId:0,userId:h||1,maintenanceId:0,description_probleme:"",photo_probleme:[],verifications_preliminaires:"",resultat_diagnostic:"",actions_correctives:"",verification_fonctionnement:"",recommandations:"",date_intervention:F}),k(t)},y=t=>{o("photo_probleme",t),u.photo_probleme&&b({...u,photo_probleme:""})},R=async t=>{const{data:l}=await z(t.id);l&&(o("maintenanceId",l[0].id),o("clientId",l[0].installation.client_id),o("description_probleme",l[0].description_probleme))},D=()=>{const t={};return i.description_probleme.trim()||(t.description_probleme="Le problème rapporté est obligatoire"),i.verifications_preliminaires.trim()||(t.verifications_preliminaires="Les vérifications préliminaires sont obligatoires"),i.resultat_diagnostic.trim()||(t.resultat_diagnostic="Le résultat du diagnostic est obligatoire"),i.actions_correctives.trim()||(t.actions_correctives="Les actions correctives sont obligatoires"),i.verification_fonctionnement.trim()||(t.verification_fonctionnement="La vérification du fonctionnement est obligatoire"),i.date_intervention||(t.date_intervention="La date d'intervention est obligatoire"),s(t),Object.keys(t).length===0},T=async()=>{if(D()){i.userId=h,i.created_via=p?"telegram_bot":"web";try{if(w(!0),i.photo_probleme&&Array.isArray(i.photo_probleme)){for(const c of i.photo_probleme)if(c.size>5*1024*1024){x({show:!0,message:`Le fichier ${c.name} est trop volumineux (max 5MB)`,type:"error"});return}}const t=new FormData;t.append("clientId",i.clientId),t.append("userId",i.userId),t.append("maintenanceId",i.maintenanceId),t.append("description_probleme",i.description_probleme),i.photo_probleme&&Array.isArray(i.photo_probleme)&&i.photo_probleme.length>0&&i.photo_probleme.forEach((c,P)=>{t.append(`photo_probleme[${P}]`,c)}),t.append("verifications_preliminaires",i.verifications_preliminaires),t.append("resultat_diagnostic",i.resultat_diagnostic),t.append("actions_correctives",i.actions_correctives),t.append("verification_fonctionnement",i.verification_fonctionnement),t.append("recommandations",i.recommandations||""),t.append("date_intervention",i.date_intervention);const l=await B(t);j(l.message)}catch(t){console.error("Erreur lors de la création du rapport:",t),x({show:!0,message:"Une erreur est survenue lors de la création du rapport",type:"error"})}finally{w(!1)}}};return e.jsxs(M,{show:E,closeable:!1,onClose:j,children:[e.jsx("div",{className:"text-2xl font-semibold text-center",children:"Formulaire rapport maintenance"}),e.jsxs("form",{className:`grid w-full grid-cols-1 gap-4 my-6 ${p?" sm:grid-cols-3":" sm:grid-cols-2"}`,children:[p&&e.jsxs("div",{children:[e.jsx(r,{htmlFor:"installation_id",value:"Code d'instalation *"}),e.jsx(G,{data:L,className:"block w-full mt-1",onSelect:R,defaultValue:i.installation_id,onFocus:()=>b({...u,installation_id:""})}),e.jsx(m,{message:u.installation_id||a.installation_id,className:"mt-2"})]}),p&&e.jsxs("div",{children:[e.jsx(r,{htmlFor:"photo_probleme",value:"Photo du problème (optionnel)"}),e.jsx(C,{ref:I,selectedFiles:i.photo_probleme,onLoadFile:y,onFocus:()=>b({...u,photo_probleme:""}),multiple:!0,placeholder:"Sélectionner des photos"})]}),p&&e.jsxs("div",{children:[e.jsx(r,{htmlFor:"date_intervention",value:"Date de l'intervention *"}),e.jsx(N,{id:"date_intervention",name:"date_intervention",value:i.date_intervention,className:"block w-full mt-1",autoComplete:"off",onChange:t=>o("date_intervention",t.target.value),type:"date",required:!0,onFocus:()=>s({...n,date_intervention:""})}),e.jsx(m,{message:n.date_intervention||a.date_intervention,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(r,{htmlFor:"description_probleme",value:"Problème rapporté *"}),e.jsx(f,{id:"description_probleme",name:"description_probleme",value:i.description_probleme,className:"block w-full mt-1",autoComplete:"off",onChange:t=>o("description_probleme",t.target.value),required:!0,rows:3,readOnly:!0,onFocus:()=>s({...n,description_probleme:""})}),e.jsx(m,{message:n.description_probleme||u.description_probleme||a.description_probleme,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(r,{htmlFor:"verifications_preliminaires",value:"Vérifications préliminaires *"}),e.jsx(f,{id:"verifications_preliminaires",name:"verifications_preliminaires",value:i.verifications_preliminaires,className:"block w-full mt-1",autoComplete:"off",onChange:t=>o("verifications_preliminaires",t.target.value),required:!0,rows:3,onFocus:()=>s({...n,verifications_preliminaires:""})}),e.jsx(m,{message:n.verifications_preliminaires||a.verifications_preliminaires,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(r,{htmlFor:"resultat_diagnostic",value:"Résultat du diagnostic *"}),e.jsx(f,{id:"resultat_diagnostic",name:"resultat_diagnostic",value:i.resultat_diagnostic,className:"block w-full mt-1",autoComplete:"off",onChange:t=>o("resultat_diagnostic",t.target.value),required:!0,rows:3,onFocus:()=>s({...n,resultat_diagnostic:""})}),e.jsx(m,{message:n.resultat_diagnostic||a.resultat_diagnostic,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(r,{htmlFor:"actions_correctives",value:"Actions correctives *"}),e.jsx(f,{id:"actions_correctives",name:"actions_correctives",value:i.actions_correctives,className:"block w-full mt-1",autoComplete:"off",onChange:t=>o("actions_correctives",t.target.value),required:!0,rows:3,onFocus:()=>s({...n,actions_correctives:""})}),e.jsx(m,{message:n.actions_correctives||a.actions_correctives,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(r,{htmlFor:"verification_fonctionnement",value:"Vérification du fonctionnement *"}),e.jsx(f,{id:"verification_fonctionnement",name:"verification_fonctionnement",value:i.verification_fonctionnement,className:"block w-full mt-1",autoComplete:"off",onChange:t=>o("verification_fonctionnement",t.target.value),required:!0,rows:3,onFocus:()=>s({...n,verification_fonctionnement:""})}),e.jsx(m,{message:n.verification_fonctionnement||a.verification_fonctionnement,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(r,{htmlFor:"recommandations",value:"Recommandations au Client (optionnel)"}),e.jsx(f,{id:"recommandations",name:"recommandations",value:i.recommandations,className:"block w-full mt-1",autoComplete:"off",onChange:t=>o("recommandations",t.target.value),rows:3,onFocus:()=>s({...n,recommandations:""})}),e.jsx(m,{message:a.recommandations,className:"mt-2"})]}),!p&&e.jsxs("div",{children:[e.jsx(r,{htmlFor:"photo_probleme",value:"Photo du problème (optionnel)"}),e.jsx(C,{ref:I,selectedFiles:i.photo_probleme,onLoadFile:y,onFocus:()=>b({...u,photo_probleme:""}),multiple:!0,placeholder:"Sélectionner des photos"})]}),!p&&e.jsxs("div",{children:[e.jsx(r,{htmlFor:"date_intervention",value:"Date de l'intervention *"}),e.jsx(N,{id:"date_intervention",name:"date_intervention",value:i.date_intervention,className:"block w-full mt-1",autoComplete:"off",onChange:t=>o("date_intervention",t.target.value),type:"date",required:!0,onFocus:()=>s({...n,date_intervention:""})}),e.jsx(m,{message:n.date_intervention||a.date_intervention,className:"mt-2"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-4 px-1",children:[e.jsx("button",{type:"button",className:"px-4 py-1 text-red-500 rounded-md bg-red-400/10",onClick:()=>j(""),children:"Fermer"}),e.jsx("button",{type:"submit",className:`rounded-md py-1 px-4 disabled:cursor-not-allowed bg-blue-500 text-white ${g&&"opacity-25"}`,disabled:g,onClick:T,children:g?"Enregistrement...":"Enregistrer"})]}),e.jsx(U,{show:v.show,message:v.message,type:v.type,onClose:()=>x({...v,show:!1})})]})};export{te as F};
