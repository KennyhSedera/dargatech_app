import{r as n,v as O,j as e,$ as H,m as W}from"./app-CTMrJVbE.js";import{C as B}from"./ConfirmDialog-5bykTzH1.js";import{D as G}from"./DataTable-BH0TmiI7.js";import{H as U}from"./HeaderPage-D_zohxKW.js";import{M as z}from"./Modal-uJXO4DKq.js";import{I as _,T as x}from"./TextInput-Dx1RUOcn.js";import{I as h}from"./InputLabel-jm0xPlGD.js";import{b as K}from"./validateForm-CYV7VTEV.js";import{g as V,c as J,u as Q,d as X}from"./installationService-CbySWcdC.js";import{I as Y}from"./InputAutocomplete -D15Jwxhf.js";import{b as Z}from"./clientService-DifjTgHZ.js";import{p as M,f as ee,q as te,r as ae}from"./constant-B1AHBpkA.js";import{S as se}from"./SelectInput-B7Uwd5km.js";import{S as oe}from"./Snackbar--bfd7mfl.js";import{A as ne,R as le}from"./AuthenticatedLayout-90isqUyw.js";import{G as re}from"./index-VERx4s6m.js";import{T as ie,a as ue}from"./index-DydNinOR.js";import{E as ce}from"./EmptyState-DqDnLNXe.js";import"./index-C8PaBlte.js";import"./iconBase-CkpjBBGi.js";import"./transition-CHNhJYYm.js";import"./createLucideIcon-C5ln3Au8.js";import"./api-BvCQBG9C.js";import"./useTheme-DYCTBjql.js";async function de(C,y){try{const b=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${C}&lon=${y}&zoom=18&addressdetails=1`)).json(),c=b.address;return{village:c.village||c.town||c.city||c.hamlet||"Non trouvé",adresse:b.display_name||"Adresse non trouvée",pays:c.country||"Pays non trouvé",region:c.state||c.region||c.county||"Région non trouvée",code_postal:c.postcode||"Code postal non trouvé",rue:c.road||c.street||"Rue non trouvée",code_pays:c.country_code?c.country_code.toUpperCase():"Code pays non trouvé"}}catch{return{village:"Erreur",adresse:"Erreur lors de la récupération",pays:"Erreur",region:"Erreur",code_postal:"Erreur",rue:"Erreur",code_pays:"Erreur"}}}const me=({open:C=!0,setOpen:y,dataModify:l={},onCloseFormulaire:b=()=>{}})=>{const[c,f]=n.useState("Enregistrer"),[F,v]=n.useState(!1),[d,j]=n.useState({}),[I,E]=n.useState([]),[$,N]=n.useState(!1),{data:s,setData:m,errors:i}=O({client_id:0,date_installation:new Date().toISOString().split("T")[0],puissance_pompe:"",profondeur_forage:"",debit_nominal:"",numero_serie:"",code_installation:"",source_eau:"Puits",hmt:"",latitude:"",longitude:"",pays:"",ville:"",statuts:"installée"}),w=n.useCallback(t=>{if(!t||t.length===0)return"I0001";const a=t.reduce((r,o)=>{var R;const q=(R=o.code_installation)==null?void 0:R.match(/I(\d+)/);if(q){const A=parseInt(q[1],10);return A>r?A:r}return r},0)+1;return`I${String(a).padStart(4,"0")}`},[]),L=n.useCallback(async()=>{try{const[{clients:t},p]=await Promise.all([Z(),V()]),a=t.map(o=>({id:o.id,nom:`${o.nom} ${o.prenom}`})),r=w(p.data);E(a),l.id||m("code_installation",r)}catch(t){console.error("Error fetching clients and installations:",t)}},[l.id,m,w]),k=n.useCallback(t=>{y(!1),S(),b(t)},[y,b]),S=n.useCallback(()=>{m({client_id:0,date_installation:new Date().toISOString().split("T")[0],puissance_pompe:"",profondeur_forage:"",debit_nominal:"",numero_serie:"",code_installation:"I0001",source_eau:"Puits",hmt:"",latitude:"",longitude:"",pays:"",ville:"",statuts:"installée"}),v(!1),f("Enregistrer"),j({})},[m]),u=n.useCallback(t=>{j(p=>({...p,[t]:""}))},[]);n.useEffect(()=>{var t,p;L(),l.id?(m({client_id:l.client_id||0,date_installation:M(l.date_installation)||new Date().toISOString().split("T")[0],puissance_pompe:l.puissance_pompe||"",profondeur_forage:l.profondeur_forage||"",debit_nominal:l.debit_nominal||"",numero_serie:l.numero_serie||"",code_installation:l.code_installation||"",source_eau:l.source_eau||"Puits",hmt:l.hmt||"",ville:((t=l.localisation)==null?void 0:t.ville)||"Kara",pays:((p=l.localisation)==null?void 0:p.pays)||"Togo",latitude:l.latitude||"",longitude:l.longitude||"",statuts:l.statuts||"installée"}),f("Modifier")):S()},[l,m,L,S]);const D=n.useCallback(async()=>{if(!s.latitude||!s.longitude){console.warn("Latitude and longitude are required for location lookup");return}N(!0);try{const t=await de(s.latitude,s.longitude);m("ville",t.region||t.village||t.adresse||prev.ville),m("pays",t.pays)}catch(t){console.error("Error getting location:",t)}finally{N(!1)}},[s.latitude,s.longitude,m]),P=async()=>{var p,a;const t=c==="Enregistrer";if(!(t&&!K(s,j))){v(!0),f("Chargement...");try{let r;t?{message:r}=await J(s):{message:r}=await Q(l.id,s),k(r)}catch(r){console.error("Error submitting installation:",r),(a=(p=r.response)==null?void 0:p.data)!=null&&a.errors?j(r.response.data.errors):j({general:"Une erreur est survenue lors de la soumission du formulaire."})}finally{v(!1),f(t?"Enregistrer":"Modifier")}}};n.useEffect(()=>{s.latitude&&s.longitude&&D()},[s.latitude,s.longitude,D]);const T=n.useCallback(t=>{m("client_id",t.id),u("client_id")},[m,u]),g=n.useCallback((t,p)=>{m(t,p),u(t)},[m,u]);return e.jsxs(z,{show:C,closeable:!1,onClose:k,maxWidth:"4xl",children:[e.jsx("div",{className:"text-2xl font-semibold text-center",children:l.id?"Modifier une Installation":"Ajouter une Installation"}),d.general&&e.jsx("div",{className:"p-3 mt-4 text-red-700 bg-red-100 border border-red-300 rounded",children:d.general}),e.jsxs("form",{className:"grid w-full grid-cols-1 gap-4 my-6 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"client_id",value:"Nom client"}),e.jsx(Y,{data:I,className:"block w-full mt-1",onSelect:T,defaultValue:s.client_id??0,onFocus:()=>u("client_id")}),e.jsx(_,{message:d.client_id||i.client_id,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"numero_serie",value:"Numéro de série de la pompe"}),e.jsx(x,{id:"numero_serie",name:"numero_serie",value:s.numero_serie,className:"block w-full mt-1",autoComplete:"numero_serie",onChange:t=>g("numero_serie",t.target.value),required:!0,onFocus:()=>u("numero_serie")}),e.jsx(_,{message:d.numero_serie||i.numero_serie,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"source_eau",value:"Source d'eau"}),e.jsxs(se,{id:"source_eau",name:"source_eau",value:s.source_eau,className:"block w-full mt-1",autoComplete:"source_eau",onChange:t=>g("source_eau",t.target.value),required:!0,children:[e.jsx("option",{value:"Puits",children:"Puits"}),e.jsx("option",{value:"Forage",children:"Forage"}),e.jsx("option",{value:"Etang",children:"Etang"}),e.jsx("option",{value:"Barrage",children:"Barrage"}),e.jsx("option",{value:"Rivière",children:"Rivière"})]}),e.jsx(_,{message:d.source_eau||i.source_eau,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"hmt",value:"HMT (m)"}),e.jsx(x,{id:"hmt",name:"hmt",value:s.hmt,className:"block w-full mt-1",autoComplete:"hmt",onChange:t=>g("hmt",t.target.value),required:!0,type:"number",onFocus:()=>u("hmt")}),e.jsx(_,{message:d.hmt||i.hmt,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"profondeur_forage",value:"Distance maximale pompe champ PV (m)"}),e.jsx(x,{id:"profondeur_forage",name:"profondeur_forage",value:s.profondeur_forage,className:"block w-full mt-1",autoComplete:"profondeur_forage",onChange:t=>g("profondeur_forage",t.target.value),required:!0,type:"number",onFocus:()=>u("profondeur_forage")}),e.jsx(_,{message:d.profondeur_forage||i.profondeur_forage,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"debit_nominal",value:"Débit nominal (m³/h)"}),e.jsx(x,{id:"debit_nominal",name:"debit_nominal",value:s.debit_nominal,className:"block w-full mt-1",autoComplete:"debit_nominal",onChange:t=>g("debit_nominal",t.target.value),required:!0,type:"number",onFocus:()=>u("debit_nominal")}),e.jsx(_,{message:d.debit_nominal||i.debit_nominal,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"puissance_pompe",value:"Puissance crête installé (W)"}),e.jsx(x,{id:"puissance_pompe",name:"puissance_pompe",value:s.puissance_pompe,className:"block w-full mt-1",autoComplete:"puissance_pompe",onChange:t=>g("puissance_pompe",t.target.value),required:!0,type:"number",onFocus:()=>u("puissance_pompe")}),e.jsx(_,{message:d.puissance_pompe||i.puissance_pompe,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"latitude",value:"Latitude"}),e.jsx(x,{id:"latitude",name:"latitude",value:s.latitude,className:"block w-full mt-1",autoComplete:"latitude",type:"number",step:"any",onChange:t=>g("latitude",t.target.value),onFocus:()=>u("latitude")}),e.jsx(_,{message:d.latitude||i.latitude,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"longitude",value:"Longitude"}),e.jsx(x,{id:"longitude",name:"longitude",value:s.longitude,className:"block w-full mt-1",autoComplete:"longitude",type:"number",step:"any",onChange:t=>g("longitude",t.target.value),onFocus:()=>u("longitude")}),e.jsx(_,{message:d.longitude||i.longitude,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"pays",value:"Pays"}),e.jsx(x,{id:"pays",name:"pays",value:s.pays,readOnly:!0,className:"block w-full mt-1",autoComplete:"pays",onChange:t=>g("pays",t.target.value),required:!0,onFocus:()=>u("pays")}),e.jsx(_,{message:d.pays||i.pays,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"ville",value:"Ville"}),e.jsx(x,{id:"ville",name:"ville",value:s.ville,readOnly:!0,className:"block w-full mt-1",autoComplete:"ville",onChange:t=>g("ville",t.target.value),required:!0,onFocus:()=>u("ville")}),e.jsx(_,{message:d.ville||i.ville,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"date_installation",value:"Date de l'installation"}),e.jsx(x,{id:"date_installation",name:"date_installation",value:s.date_installation,className:"block w-full mt-1",autoComplete:"date_installation",type:"date",onChange:t=>g("date_installation",t.target.value),required:!0,onFocus:()=>u("date_installation")}),e.jsx(_,{message:d.date_installation||i.date_installation,className:"mt-2"})]})]}),e.jsx("div",{className:"flex items-center justify-end px-1",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{type:"button",className:"px-4 py-2 text-red-500 rounded-md bg-red-400/10 hover:bg-red-400/20",onClick:()=>k(""),children:"Fermer"}),e.jsx("button",{type:"submit",className:`rounded-md py-2 px-4 disabled:cursor-not-allowed bg-blue-500 text-white hover:bg-blue-600 ${F&&"opacity-50"}`,disabled:F,onClick:P,children:c})]})})]})},Re=()=>{const[C,y]=n.useState(""),[l,b]=n.useState(!1),[c,f]=n.useState({}),[F,v]=n.useState(1),[d,j]=n.useState([]),[I,E]=n.useState([]),[$,N]=n.useState(!0),[s,m]=n.useState({open:!1,message:"",id:0}),[i,w]=n.useState({open:!1,message:"",type:"success"}),L=[{key:"code_installation",label:"Code",sortable:!0},{key:"nom",label:"Nom client",sortable:!0},{key:"numero_serie",label:"Numéro de série de la pompe",sortable:!0},{key:"puissance_pompe",label:"Puissance crête installé (W)"},{key:"profondeur_forage",label:"Distance maximale pompe champ PV (m)"},{key:"debit_nominal",label:"Débit nominal (m³/h)"},{key:"source_eau",label:"Source d'eau"},{key:"hmt",label:"HMT (m)"},{key:"date_installation",label:"Date de l'installation",sortable:!0},{key:"statuts",label:"Statuts",customRender:a=>e.jsx("span",{className:`px-2 py-1 rounded-full text-white flex text-nowrap cursor-pointer ${a==="installée"?"bg-green-500/50":a==="en cours"?"bg-blue-500/50":"bg-red-500/50"}`,children:a})},{key:"created_via",label:"Via",customRender:a=>e.jsx("span",{className:"text-xl font-medium text-gray-900 dark:text-white",children:a==="web"?e.jsx(ue,{}):e.jsx(le,{className:"text-blue-400 bg-white"})})}],k=[{label:e.jsx(te,{className:"text-base"}),color:"text-green-500",hoverColor:"text-green-600",handler:a=>p(a.id)},{label:e.jsx(ie,{className:"text-lg"}),color:"text-blue-500",hoverColor:"text-blue-600",handler:a=>t(a)},{label:e.jsx(re,{className:"text-base"}),color:"text-red-500",hoverColor:"text-red-600",handler:a=>T(a)}],S=()=>{b(!0)},u=async()=>{N(!0);const{data:a}=await V(),r=a.map(o=>({id:o.id,code_installation:o.code_installation,client_id:o.client_id,nom:o.client.nom+" "+o.client.prenom,puissance_pompe:o.puissance_pompe,profondeur_forage:o.profondeur_forage,debit_nominal:o.debit_nominal,numero_serie:o.numero_serie,source_eau:o.source_eau,hmt:o.hmt,date_installation:ee(o.date_installation),statuts:o.statuts,latitude:o.localisation.latitude,longitude:o.localisation.longitude,created_via:o.created_via}));j(r),E(r),N(!1)};n.useEffect(()=>{u()},[]);const D=a=>{y(a),v(1);const r=d.filter(o=>o.nom.toLowerCase().includes(a.toLowerCase())||o.code_installation.toLowerCase().includes(a.toLowerCase())||o.numero_serie.toLowerCase().includes(a.toLowerCase())||o.source_eau.toLowerCase().includes(a.toLowerCase())||o.statuts.toLowerCase().includes(a.toLowerCase())||o.date_installation.toString().toLowerCase().includes(a.toLowerCase()));E(r)},P=a=>{u(),a&&w({...i,message:a,open:!0}),f({})},T=a=>{m({open:!0,message:`Êtes-vous sûr de vouloir supprimer l'installation numéro ${a.code_installation} du ${a.nom} le ${a.date_installation} ?`,id:a.id})},g=async()=>{const{message:a}=await X(s.id);w({...i,message:a,open:!0}),m({...s,open:!1,id:0}),u(),v(1)},t=a=>{const r=a.date_installation?a.date_installation:"Invalid date";f({...a,date_installation:ae(r)}),b(!0)},p=a=>{W.visit(`/installation/${a}`)};return e.jsxs(ne,{children:[e.jsx(H,{title:"Installations"}),e.jsx(U,{title:`Liste des Installations ( Total: ${d.length} )`,handleClick:S,onSearch:D,search:C}),e.jsx(me,{open:l,setOpen:b,onCloseFormulaire:P,dataModify:c}),e.jsx(oe,{message:i.message,type:i.type,duration:3e3,position:"top-right",show:i.open,onClose:()=>w({...i,message:"",open:!1})}),e.jsx(B,{open:s.open,message:s.message,btnAcceptName:"Supprimer",title:"Suppression",btnAcceptColor:"bg-red-500 text-white",close:()=>m({...s,open:!1}),accept:g}),$?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"w-12 h-12 border-t-2 border-b-2 border-blue-500 rounded-full animate-spin"})}):e.jsx("div",{children:I.length>0?e.jsx(G,{headers:L,rows:I,itemsPerPage:6,actions:k,className:"mt-4",currentPage:F,onPageChange:v,masqueColumns:["client_id","latitude","longitude"]}):e.jsx(ce,{nom:"installation",search:C})})]})};export{Re as default};
