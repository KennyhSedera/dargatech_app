import{r as i,v as V,j as e,q as Z,$ as ee,m as O}from"./app-c3qJI57q.js";import{C as te}from"./ConfirmDialog-CRFY0WwR.js";import{D as ne}from"./DataTable-DxBbA0zA.js";import{E as oe}from"./EmptyState-CgYYjtgj.js";import{H as re}from"./HeaderPage-BRlTcsAA.js";import{M as B}from"./Modal-BdS7sgfq.js";import{I as g,T as z}from"./TextInput-BgJ2t9aS.js";import{I as h}from"./InputLabel-C-TZjnWz.js";import{g as ie}from"./installationService-BAT2NCVg.js";import{I as se}from"./InputAutocomplete -C3xGedJL.js";import{p as ae,f as le,q as ce}from"./constant-DEY8BttC.js";import{a as R}from"./api-Bi4KaLps.js";import{S as me}from"./SelectInput-CzwjY-Zr.js";import{c as de}from"./validateForm-CYV7VTEV.js";import{T as D}from"./TextArea-ClhMhdDz.js";import{I as pe}from"./InputImage-DkSTJlN6.js";import{S as G}from"./Snackbar-CvWaLRwL.js";import{A as ue}from"./AuthenticatedLayout-cwMz5Lyt.js";import{G as _e}from"./index-C8bcBNXW.js";import{T as ve}from"./index-DQvrfVrX.js";import"./index-mfF9RBAU.js";import"./iconBase-8XtX0Jdf.js";import"./transition-PLd8YbUn.js";import"./index-Ze9ldLz0.js";import"./useTheme-_SBbUE7y.js";const fe=async()=>{try{return(await R.get("/maintenance")).data}catch(a){throw console.error("Erreur lors de la récupération des maintenances",a),a}},be=async a=>{try{return(await R.post("/maintenance",a)).data}catch(s){throw console.error("Erreur lors de l'enregistrement du maintenance",s),s}},he=async(a,s)=>{try{return(await R.put(`/maintenance/${a}`,s)).data}catch(r){throw console.error("Erreur lors de la modification du maintenance",r),r}},ge=async a=>{try{return(await R.delete(`/maintenance/${a}`)).data}catch(s){throw console.error("Erreur lors de la suppression du maintenance",s),s}},xe=async a=>{try{return(await R.post("/rapport-maintenances",a)).data}catch(s){throw console.error("Erreur lors de la création du rapport de maintenance",s),s}},je=({open:a=!0,setOpen:s,dataModify:r={},onCloseFormulaire:L=()=>{},idTechnicien:x})=>{const[w,o]=i.useState("Enregistrer"),[l,_]=i.useState(!1),[v,j]=i.useState({}),[c,f]=i.useState([]),{data:d,setData:u,errors:F,reset:C}=V({installation_id:0,date_intervention:new Date().toISOString().split("T")[0],type_intervention:"préventive",description_probleme:"",solutions_apportees:"",duree_intervention:"",technicien:x}),S=async()=>{const[{data:t}]=await Promise.all([ie()]),y=t.filter(p=>p.statuts!=="en panne").map(p=>({id:p.id,nom:p.code_installation}));f(y)},N=t=>{s(!1),E(),L(t)},E=()=>{C(),_(!1),o("Enregistrer"),j({})};i.useEffect(()=>{S(),r.id?(u({installation_id:r.installation_id||0,date_intervention:ae(r.date_intervention)||new Date().toISOString().split("T")[0],type_intervention:r.type_intervention||"",description_probleme:r.description_probleme||"",solutions_apportees:r.solutions_apportees||"",duree_intervention:r.duree_intervention||"",technicien:r.technicien_id||0}),o("Modifier")):E()},[r,u]),i.useEffect(()=>{x&&u("technicien",x)},[x,u]);const I=async()=>{if(de(d,j)){_(!0),o("Chargement...");try{let t;w==="Enregistrer"?{message:t}=await be(d):{message:t}=await he(r.id,d),N(t)}catch(t){console.error("Error submitting payment:",t)}finally{_(!1),o("Enregistrer")}}},k=t=>{u({...d,installation_id:t.id,description_probleme:t.message})};return e.jsxs(B,{show:a,closeable:!1,onClose:N,maxWidth:"lg",children:[e.jsx("div",{className:"text-2xl font-semibold text-center",children:r.nom?"Modifier une Intervention":"Ajouter une Intervention"}),e.jsxs("form",{className:"grid w-full grid-cols-1 gap-4 px-6 my-6",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"installation_id",value:"Code d'instalation"}),e.jsx(se,{data:c,className:"block w-full mt-1",onSelect:k,defaultValue:d.installation_id,readOnly:r.id,onFocus:()=>j({...v,installation_id:""})}),e.jsx(g,{message:v.installation_id||F.installation_id,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"type_intervention",value:"Type d'intervention"}),e.jsxs(me,{id:"type_intervention",type:"type_intervention",name:"type_intervention",value:d.type_intervention,className:"block w-full mt-1",autoComplete:"type_intervention",onChange:t=>u("type_intervention",t.target.value),required:!0,children:[e.jsx("option",{value:"préventive",children:"Préventive"}),e.jsx("option",{value:"curative",children:"Curative"})]}),e.jsx(g,{message:F.email,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"description_probleme",value:"Description du problème"}),e.jsx(D,{id:"description_probleme",name:"description_probleme",value:d.description_probleme,className:"block w-full mt-1",autoComplete:"description_probleme",onChange:t=>u("description_probleme",t.target.value),required:!0,rows:4,onFocus:()=>j({...v,description_probleme:""})}),e.jsx(g,{message:v.description_probleme||F.description_probleme,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"date_intervention",value:"Date d'intervention"}),e.jsx(z,{id:"date_intervention",name:"date_intervention",value:d.date_intervention,className:"block w-full mt-1",autoComplete:"date_intervention",type:"date",onChange:t=>u("date_intervention",t.target.value),required:!0,onFocus:()=>j({...v,date_intervention:""})}),e.jsx(g,{message:v.date_intervention||F.date_intervention,className:"mt-2"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-4 px-6",children:[e.jsx("button",{type:"button",className:"px-4 py-1 text-red-500 rounded-md bg-red-400/10",onClick:()=>N(""),children:"Fermer"}),e.jsx("button",{type:"submit",className:`rounded-md py-1 px-4 disabled:cursor-not-allowed bg-blue-500 text-white ${l&&"opacity-25"}`,disabled:l,onClick:I,children:w})]})]})},ye=({open:a=!0,setOpen:s,dataModify:r={},onCloseFormulaire:L=()=>{},idTechnicien:x})=>{const w=new Date().toISOString().split("T")[0],{data:o,setData:l,errors:_}=V({clientId:0,technicienId:x,maintenanceId:0,description_probleme:"",photo_probleme:[],verifications_preliminaires:"",resultat_diagnostic:"",actions_correctives:"",verification_fonctionnement:"",recommandations:"",date_intervention:w}),[v,j]=i.useState(!1),[c,f]=i.useState({}),[d,u]=i.useState({show:!1,message:"",type:"info"});i.useEffect(()=>{r&&(l("maintenanceId",r.id),l("clientId",r.idclient),l("description_probleme",r.description_probleme))},[r]);const F=i.useRef(null),[C,S]=i.useState({}),N=t=>{s(!1),l({clientId:0,technicienId:x||1,maintenanceId:0,description_probleme:"",photo_probleme:[],verifications_preliminaires:"",resultat_diagnostic:"",actions_correctives:"",verification_fonctionnement:"",recommandations:"",date_intervention:w}),L(t)},E=t=>{console.log(t),l("photo_probleme",t),C.photo_probleme&&S({...C,photo_probleme:""})},I=()=>{const t={};return o.description_probleme.trim()||(t.description_probleme="Le problème rapporté est obligatoire"),o.verifications_preliminaires.trim()||(t.verifications_preliminaires="Les vérifications préliminaires sont obligatoires"),o.resultat_diagnostic.trim()||(t.resultat_diagnostic="Le résultat du diagnostic est obligatoire"),o.actions_correctives.trim()||(t.actions_correctives="Les actions correctives sont obligatoires"),o.verification_fonctionnement.trim()||(t.verification_fonctionnement="La vérification du fonctionnement est obligatoire"),o.date_intervention||(t.date_intervention="La date d'intervention est obligatoire"),f(t),Object.keys(t).length===0},k=async()=>{if(I()){o.technicienId=x;try{if(j(!0),o.photo_probleme&&Array.isArray(o.photo_probleme)){for(const p of o.photo_probleme)if(p.size>5*1024*1024){u({show:!0,message:`Le fichier ${p.name} est trop volumineux (max 5MB)`,type:"error"});return}}const t=new FormData;t.append("clientId",o.clientId),t.append("technicienId",o.technicienId),t.append("maintenanceId",o.maintenanceId),t.append("description_probleme",o.description_probleme),o.photo_probleme&&Array.isArray(o.photo_probleme)&&o.photo_probleme.length>0&&o.photo_probleme.forEach((p,T)=>{t.append(`photo_probleme[${T}]`,p)}),t.append("verifications_preliminaires",o.verifications_preliminaires),t.append("resultat_diagnostic",o.resultat_diagnostic),t.append("actions_correctives",o.actions_correctives),t.append("verification_fonctionnement",o.verification_fonctionnement),t.append("recommandations",o.recommandations||""),t.append("date_intervention",o.date_intervention),console.log("Data object:",o);const y=await xe(t);N(y.message),console.log(y.data)}catch(t){console.error("Erreur lors de la création du rapport:",t),u({show:!0,message:"Une erreur est survenue lors de la création du rapport",type:"error"})}finally{j(!1)}}};return e.jsxs(B,{show:a,closeable:!1,onClose:N,maxWidth:"xl",children:[e.jsx("div",{className:"text-2xl font-semibold text-center",children:"Formulaire rapport maintenance"}),e.jsxs("form",{className:"grid w-full grid-cols-1 gap-4 my-6 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"description_probleme",value:"Problème rapporté *"}),e.jsx(D,{id:"description_probleme",name:"description_probleme",value:o.description_probleme,className:"block w-full mt-1",autoComplete:"off",onChange:t=>l("description_probleme",t.target.value),required:!0,rows:3,readOnly:!0,onFocus:()=>f({...c,description_probleme:""})}),e.jsx(g,{message:c.description_probleme||C.description_probleme||_.description_probleme,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"verifications_preliminaires",value:"Vérifications préliminaires *"}),e.jsx(D,{id:"verifications_preliminaires",name:"verifications_preliminaires",value:o.verifications_preliminaires,className:"block w-full mt-1",autoComplete:"off",onChange:t=>l("verifications_preliminaires",t.target.value),required:!0,rows:3,onFocus:()=>f({...c,verifications_preliminaires:""})}),e.jsx(g,{message:c.verifications_preliminaires||_.verifications_preliminaires,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"resultat_diagnostic",value:"Résultat du diagnostic *"}),e.jsx(D,{id:"resultat_diagnostic",name:"resultat_diagnostic",value:o.resultat_diagnostic,className:"block w-full mt-1",autoComplete:"off",onChange:t=>l("resultat_diagnostic",t.target.value),required:!0,rows:3,onFocus:()=>f({...c,resultat_diagnostic:""})}),e.jsx(g,{message:c.resultat_diagnostic||_.resultat_diagnostic,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"actions_correctives",value:"Actions correctives *"}),e.jsx(D,{id:"actions_correctives",name:"actions_correctives",value:o.actions_correctives,className:"block w-full mt-1",autoComplete:"off",onChange:t=>l("actions_correctives",t.target.value),required:!0,rows:3,onFocus:()=>f({...c,actions_correctives:""})}),e.jsx(g,{message:c.actions_correctives||_.actions_correctives,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"verification_fonctionnement",value:"Vérification du fonctionnement *"}),e.jsx(D,{id:"verification_fonctionnement",name:"verification_fonctionnement",value:o.verification_fonctionnement,className:"block w-full mt-1",autoComplete:"off",onChange:t=>l("verification_fonctionnement",t.target.value),required:!0,rows:3,onFocus:()=>f({...c,verification_fonctionnement:""})}),e.jsx(g,{message:c.verification_fonctionnement||_.verification_fonctionnement,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"recommandations",value:"Recommandations au Client (optionnel)"}),e.jsx(D,{id:"recommandations",name:"recommandations",value:o.recommandations,className:"block w-full mt-1",autoComplete:"off",onChange:t=>l("recommandations",t.target.value),rows:3,onFocus:()=>f({...c,recommandations:""})}),e.jsx(g,{message:_.recommandations,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"photo_probleme",value:"Photo du problème (optionnel)"}),e.jsx(pe,{ref:F,selectedFiles:o.photo_probleme,onLoadFile:E,onFocus:()=>S({...C,photo_probleme:""})})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"date_intervention",value:"Date de l'intervention *"}),e.jsx(z,{id:"date_intervention",name:"date_intervention",value:o.date_intervention,className:"block w-full mt-1",autoComplete:"off",onChange:t=>l("date_intervention",t.target.value),type:"date",required:!0,onFocus:()=>f({...c,date_intervention:""})}),e.jsx(g,{message:c.date_intervention||_.date_intervention,className:"mt-2"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-4 px-1",children:[e.jsx("button",{type:"button",className:"px-4 py-1 text-red-500 rounded-md bg-red-400/10",onClick:()=>N(""),children:"Fermer"}),e.jsx("button",{type:"submit",className:`rounded-md py-1 px-4 disabled:cursor-not-allowed bg-blue-500 text-white ${v&&"opacity-25"}`,disabled:v,onClick:k,children:v?"Enregistrement...":"Enregistrer"})]}),e.jsx(G,{show:d.show,message:d.message,type:d.type,onClose:()=>u({...d,show:!1})})]})},Je=()=>{const[a,s]=i.useState(""),[r,L]=i.useState(0),[x,w]=i.useState(!1),[o,l]=i.useState(!1),[_,v]=i.useState({}),[j,c]=i.useState({}),[f,d]=i.useState(1),[u,F]=i.useState([]),[C,S]=i.useState([]),[N,E]=i.useState(!0),[I,k]=i.useState({open:!1,message:"",id:0}),[t,y]=i.useState({open:!1,message:"",type:"success"}),p=Z().props.auth.user,T=[{key:"id",label:"ID",sortable:!0},{key:"code_installation",label:"Installation",sortable:!0},{key:"nom",label:"Client",sortable:!0},{key:"type_intervention",label:"Type"},{key:"description_probleme",label:"Problème",customRender:n=>e.jsxs("div",{className:"relative max-w-md group",children:[e.jsx("span",{className:"line-clamp-2",children:n}),e.jsx("div",{className:"absolute bottom-0 left-0 z-50 hidden max-w-md p-2 mt-2 text-sm text-gray-800 bg-white border border-gray-300 rounded shadow-md group-hover:block",children:n})]})},{key:"date_intervention",label:"Date d'intervenir",sortable:!0},{key:"status_intervention",label:"Statuts",customRender:n=>e.jsx("span",{className:`px-2 py-1 rounded-full text-white flex text-nowrap ${n==="terminée"?"bg-green-500/50":n==="en attente"?"bg-blue-500/50":"bg-red-500/50"}`,children:n})},{key:"status_intervention",label:"Rapport",sortable:!0,customRender:(n,b)=>{var m,$,q;return e.jsx("span",{onClick:()=>{var P;return n==="terminée"?O.visit("/rapport",{data:{intervention_id:b.id}}):((P=p.user_role)==null?void 0:P.name)==="partenaire"?null:W(b)},className:`px-2 py-1 rounded-full flex text-nowrap ${((m=p.user_role)==null?void 0:m.name)==="partenaire"&&n!=="terminée"?"cursor-default":"cursor-pointer"} ${n==="terminée"?"text-green-500":(($=p.user_role)==null?void 0:$.name)==="partenaire"?"text-gray-300":"text-blue-500"}`,children:n==="terminée"?"Consulter":((q=p.user_role)==null?void 0:q.name)==="partenaire"?"En attente":"Ajouter"})}}],H=[{label:e.jsx(ve,{className:"text-lg"}),color:"text-blue-500",hoverColor:"text-blue-600",handler:n=>Y(n)},{label:e.jsx(_e,{className:"text-base"}),color:"text-red-500",hoverColor:"text-red-600",handler:n=>Q(n)}],M=()=>{w(!0)},W=n=>{var b;((b=p.user_role)==null?void 0:b.name)==="partenaire"?O.visit("/rapport",{data:{intervention_id:n.id}}):(l(!0),c(n))},A=async()=>{E(!0);const{data:n}=await fe(),b=n.map(m=>({id:m.id,installation_id:m.installation_id,code_installation:m.installation.code_installation,nom:m.installation.client.nom+" "+m.installation.client.prenom,idclient:m.installation.client.id,type_intervention:m.type_intervention,description_probleme:m.description_probleme,status_intervention:m.status_intervention,date_intervention:le(m.date_intervention)}));F(b),S(b),E(!1)};i.useEffect(()=>{A()},[]);const U=n=>{s(n),d(1);const b=u.filter(m=>m.nom.toLowerCase().includes(n.toLowerCase())||m.type_intervention.toLowerCase().includes(n.toLowerCase())||m.description_probleme.toLowerCase().includes(n.toLowerCase())||m.date_intervention.toString().toLowerCase().includes(n.toLowerCase()));S(b)},J=n=>{A(),n&&y({...t,message:n,open:!0}),v({})},K=n=>{A(),n&&y({...t,message:n,open:!0}),c({})},Q=n=>{k({open:!0,message:`Êtes-vous sûr de vouloir supprimer l'intervention du ${n.nom} le ${n.date_intervention} ?`,id:n.id})},X=async()=>{const{message:n}=await ge(I.id);y({...t,message:n,open:!0}),k({...I,open:!1,id:0}),A(),d(1)},Y=n=>{const b=n.date_intervention?n.date_intervention:"Invalid date";v({...n,date_intervention:ce(b)}),w(!0)};return e.jsxs(ue,{setId:L,children:[e.jsx(ee,{title:"Maintenance"}),e.jsx(re,{search:a,onSearch:U,title:"Liste des interventions",handleClick:M}),e.jsx(G,{message:t.message,type:t.type,duration:3e3,position:"top-right",show:t.open,onClose:()=>y({...t,message:"",open:!1})}),e.jsx(te,{open:I.open,message:I.message,btnAcceptName:"Supprimer",title:"Suppression",btnAcceptColor:"bg-red-500 text-white",close:()=>k({...I,open:!1}),accept:X}),e.jsx(je,{open:x,setOpen:w,dataModify:_,onCloseFormulaire:J,idTechnicien:r}),e.jsx(ye,{open:o,setOpen:l,dataModify:j,onCloseFormulaire:K,idTechnicien:r}),N?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"w-12 h-12 border-t-2 border-b-2 border-blue-500 rounded-full animate-spin"})}):e.jsx("div",{children:C.length>0?e.jsx(ne,{headers:T,rows:C,itemsPerPage:6,actions:H,className:"mt-4",currentPage:f,onPageChange:d,masqueColumns:["client_id"]}):e.jsx(oe,{nom:"intervention",search:a})})]})};export{Je as default};
